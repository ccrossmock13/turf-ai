<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Profile - Greenside AI</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='8' fill='%231a4d2e'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-family='system-ui' font-size='18' font-weight='700' fill='white'%3EG%3C/text%3E%3C/svg%3E">
    <style>
        :root {
            --color-primary: #1a4d2e;
            --color-primary-hover: #2d7a4a;
            --color-primary-dark: #143d24;
            --color-primary-light: #f0fdf4;
            --color-primary-ring: rgba(26, 77, 46, 0.15);
            --color-bg: #f5f7f5;
            --color-surface: #ffffff;
            --color-surface-hover: #f9fafb;
            --color-border: #e5e7eb;
            --color-border-light: #f3f4f6;
            --color-text: #1a1a1a;
            --color-text-secondary: #374151;
            --color-text-muted: #6b7280;
            --color-text-faint: #9ca3af;
            --color-error: #dc2626;
            --color-success: #166534;
            --color-success-bg: #dcfce7;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 1px 4px rgba(0,0,0,0.06);
            --shadow-lg: 0 4px 12px rgba(0,0,0,0.08);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition-base: 0.2s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        header { background: var(--color-primary); padding: 14px 24px; }
        .header-content { max-width: 900px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
        .logo { color: white; font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
        .nav-links a { color: rgba(255,255,255,0.85); text-decoration: none; font-size: 14px; margin-left: 20px; transition: color var(--transition-base); }
        .nav-links a:hover { color: white; }

        .profile-container { max-width: 720px; margin: 0 auto; padding: 32px 24px 120px; }
        .welcome-banner { display: none; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover)); color: white; padding: 20px 24px; border-radius: 12px; margin-bottom: 24px; }
        .welcome-banner h2 { font-size: 18px; margin-bottom: 6px; }
        .welcome-banner p { font-size: 14px; opacity: 0.9; }
        .page-title { font-size: 22px; color: var(--color-primary); margin-bottom: 4px; }
        .page-subtitle { color: var(--color-text-muted); font-size: 14px; margin-bottom: 16px; }

        /* Completeness bar */
        .completeness-bar { margin-bottom: 20px; padding: 12px 16px; background: white; border-radius: 10px; box-shadow: var(--shadow-sm); }
        .completeness-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
        .completeness-header span { font-size: 13px; font-weight: 600; color: var(--color-text-secondary); }
        .completeness-track { height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
        .completeness-fill { height: 100%; width: 0%; border-radius: 3px; transition: width 0.4s ease, background 0.4s ease; }
        .completeness-label { font-size: 12px; color: var(--color-text-muted); margin-top: 4px; }

        /* Tab bar */
        .tab-bar { display: flex; gap: 4px; margin-bottom: 20px; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; position: sticky; top: 0; z-index: 10; background: var(--color-bg, #f5f7f5); padding: 12px 0; }
        .tab-bar::-webkit-scrollbar { display: none; }
        .tab-btn { padding: 10px 16px; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 13px; font-weight: 600; color: var(--color-text-muted); cursor: pointer; white-space: nowrap; transition: all var(--transition-base); }
        .tab-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }
        .tab-btn.active { background: var(--color-primary); color: white; border-color: var(--color-primary); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Sections & forms */
        .section { background: var(--color-surface); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: 28px 24px; margin-bottom: 20px; box-shadow: var(--shadow-md); transition: box-shadow var(--transition-base); }
        .section:hover { box-shadow: var(--shadow-lg); }
        .section h3 { font-size: 16px; color: var(--color-primary); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--color-border); }
        .section h4 { font-size: 14px; color: var(--color-text-secondary); margin-bottom: 12px; margin-top: 20px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        .form-row.single { grid-template-columns: 1fr; }
        .form-row.quad { grid-template-columns: repeat(4, 1fr); }
        .form-group { margin-bottom: 0; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--color-text-secondary); margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: var(--radius-md);
            font-size: 15px; outline: 2px solid transparent; transition: border-color var(--transition-base), box-shadow var(--transition-base); background: var(--color-surface);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--color-primary-hover); box-shadow: 0 0 0 3px var(--color-primary-ring); }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .help-text { font-size: 11px; color: var(--color-text-faint); margin-top: 3px; line-height: 1.4; }
        .cultivar-input { margin-top: 6px; font-size: 13px !important; padding: 8px 12px !important; color: #6b7280; }
        .cultivar-input::placeholder { color: #b0b7c3; }

        /* Checkbox labels for problems */
        .cb-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
        .cb-group-label { font-size: 12px; font-weight: 600; color: var(--color-text-secondary); margin: 12px 0 6px; }
        .cb-label { display: flex; align-items: center; gap: 5px; font-size: 13px; cursor: pointer; padding: 4px 10px; border: 1px solid var(--color-border); border-radius: 20px; transition: all var(--transition-base); user-select: none; }
        .cb-label:hover { border-color: var(--color-primary); }
        .cb-label:has(input:checked) { background: var(--color-primary-light); border-color: var(--color-primary); color: var(--color-primary); }
        .cb-label input[type="checkbox"] { width: 14px; height: 14px; accent-color: var(--color-primary); }

        /* Save bar */
        .save-bar { position: sticky; bottom: 0; background: var(--color-bg); padding: 16px 0; border-top: 1px solid var(--color-border); display: flex; align-items: center; gap: 16px; z-index: 10; }
        .save-btn { padding: 12px 32px; background: var(--color-primary); color: white; border: none; border-radius: var(--radius-md); font-size: 15px; font-weight: 600; cursor: pointer; transition: all var(--transition-base); }
        .save-btn:hover { background: var(--color-primary-hover); box-shadow: var(--shadow-md); }
        .save-btn:active { transform: scale(0.98); }
        .save-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .save-toast { display: none; color: #059669; font-size: 14px; font-weight: 500; }
        .skip-link { display: none; text-align: center; margin-top: 12px; }
        .skip-link a { color: #6b7280; text-decoration: none; font-size: 14px; }
        .skip-link a:hover { color: var(--color-primary); }
        .go-chat-btn { display: none; padding: 12px 32px; background: white; color: var(--color-primary); border: 2px solid var(--color-primary); border-radius: var(--radius-md); font-size: 15px; font-weight: 600; cursor: pointer; text-decoration: none; transition: all var(--transition-base); }
        .go-chat-btn:hover { background: var(--color-primary-light); }

        /* Context preview card */
        .context-card { background: var(--color-primary-light); border: 1px solid #86efac; border-radius: var(--radius-lg); padding: 20px 24px; margin-bottom: 20px; }
        .context-card h3 { font-size: 15px; color: var(--color-primary); margin-bottom: 0; padding: 0; border: 0; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .context-card .chevron { transition: transform var(--transition-base); font-size: 14px; color: var(--color-text-faint); }
        .context-card.open .chevron { transform: rotate(180deg); }
        .context-body { display: none; margin-top: 12px; }
        .context-card.open .context-body { display: block; }
        .context-text { white-space: pre-wrap; font-size: 13px; color: var(--color-text-secondary); line-height: 1.6; background: white; padding: 12px 16px; border-radius: var(--radius-md); border: 1px solid var(--color-border-light); }

        /* Sprayer styles */
        .sprayer-card { display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; }
        .sprayer-card-body { flex: 1; }
        .sprayer-name { font-weight: 600; color: var(--color-primary); font-size: 14px; }
        .sprayer-default-badge { background: #dbeafe; color: #1e40af; padding: 1px 6px; border-radius: 8px; font-size: 10px; font-weight: 600; margin-left: 6px; }
        .sprayer-detail { font-size: 12px; color: #6b7280; margin-top: 2px; }
        .sprayer-link { background: none; border: none; cursor: pointer; font-size: 13px; padding: 4px 8px; }
        .sprayer-form-panel { display: none; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; margin-bottom: 12px; }

        @media (max-width: 640px) {
            .form-row { grid-template-columns: 1fr; }
            .form-row.quad { grid-template-columns: 1fr 1fr; }
            .profile-container { padding: 20px 12px 120px; }
            .section { padding: 20px 16px; }
            .tab-bar { gap: 2px; }
            .tab-btn { padding: 8px 12px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="/" style="text-decoration:none;"><div class="logo">Greenside AI</div></a>
            <div class="nav-links">
                <a href="/">Chat</a>
                <a href="/spray-tracker">Spray Tracker</a>
                <a href="/resources">Resources</a>
                <a href="/logout">Log out</a>
            </div>
        </div>
    </header>

    <div class="profile-container">
        <div class="welcome-banner" id="welcome-banner">
            <h2>Welcome to Greenside AI!</h2>
            <p>Set up your course profile so the AI can tailor recommendations to your grass types, region, and setup.</p>
        </div>

        <h1 class="page-title">Course Profile</h1>
        <div class="completeness-bar">
            <div class="completeness-header">
                <span>Profile Completeness</span>
            </div>
            <div class="completeness-track"><div id="completeness-bar" class="completeness-fill"></div></div>
            <div id="completeness-label" class="completeness-label">Checking...</div>
        </div>
        <p class="page-subtitle">Your profile personalizes AI recommendations — no need to repeat your grass type or location every question.</p>

        <!-- Tab bar -->
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="basics">Basics</button>
            <button class="tab-btn" data-tab="grasses">Grasses & Mowing</button>
            <button class="tab-btn" data-tab="sprayers">Sprayers</button>
            <button class="tab-btn" data-tab="programs">Programs</button>
            <button class="tab-btn" data-tab="soil-water">Soil & Water</button>
        </div>

        <!-- ===== TAB 1: BASICS ===== -->
        <div class="tab-panel active" id="tab-basics">
            <div class="section">
                <h3>Basic Info</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="course_name">Course / Facility Name</label>
                        <input type="text" id="course_name" placeholder="e.g. Pine Valley Golf Club">
                    </div>
                    <div class="form-group">
                        <label for="turf_type">Facility Type</label>
                        <select id="turf_type" onchange="onFacilityTypeChange()">
                            <option value="">Select type...</option>
                            <option value="golf_course">Golf Course</option>
                            <option value="sports_field">Sports Field</option>
                            <option value="lawn_care">Lawn Care</option>
                            <option value="municipal">Municipal / Parks</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" id="city" placeholder="e.g. Pine Valley">
                    </div>
                    <div class="form-group">
                        <label for="state">State</label>
                        <select id="state"><option value="">Select state...</option></select>
                        <span class="help-text">Auto-sets your region and climate zone</span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="role">Your Role</label>
                        <select id="role">
                            <option value="">Select role...</option>
                            <option value="superintendent">Superintendent</option>
                            <option value="assistant_superintendent">Assistant Superintendent</option>
                            <option value="spray_tech">Spray Technician</option>
                            <option value="grounds_manager">Grounds Manager</option>
                            <option value="lawn_care_operator">Lawn Care Operator</option>
                            <option value="student">Student</option>
                            <option value="other">Other</option>
                        </select>
                        <span class="help-text">AI adjusts tone and detail level to your role</span>
                    </div>
                    <div class="form-group">
                        <label for="climate_zone">USDA Hardiness Zone <span style="font-weight:400;color:#9ca3af;">(auto from state)</span></label>
                        <input type="text" id="climate_zone" placeholder="e.g. 7a" maxlength="10">
                        <span class="help-text">Override if your microclimate differs</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== TAB 2: GRASSES & MOWING ===== -->
        <div class="tab-panel" id="tab-grasses">
            <div class="section">
                <h3>Grass Types</h3>
                <!-- Non-golf primary grass -->
                <div id="primary-grass-group">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="primary_grass">Primary Grass Type</label>
                            <select id="primary_grass"><option value="">Select grass type...</option></select>
                            <input type="text" id="primary_grass_cultivar" class="cultivar-input" placeholder="Cultivar (e.g. Tifway 419, A-4)">
                        </div>
                        <div class="form-group">
                            <label for="mow_primary">Mowing Height (inches)</label>
                            <input type="number" id="mow_primary" step="0.05" min="0.05" max="5" placeholder="e.g. 2.5">
                            <span class="help-text">Affects disease and product recommendations</span>
                        </div>
                    </div>
                </div>

                <!-- Golf course per-area grasses -->
                <div id="golf-grass-section" style="display:none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="greens_grass">Greens</label>
                            <select id="greens_grass"><option value="">Select grass...</option></select>
                            <input type="text" id="greens_grass_cultivar" class="cultivar-input" placeholder="Cultivar (e.g. Pure Distinction, L-93)">
                        </div>
                        <div class="form-group">
                            <label for="tees_grass">Tees</label>
                            <select id="tees_grass"><option value="">Select grass...</option></select>
                            <input type="text" id="tees_grass_cultivar" class="cultivar-input" placeholder="Cultivar (optional)">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fairways_grass">Fairways — Primary</label>
                            <select id="fairways_grass"><option value="">Select grass...</option></select>
                            <input type="text" id="fairways_grass_cultivar" class="cultivar-input" placeholder="Cultivar (e.g. Tifway 419)">
                        </div>
                        <div class="form-group">
                            <label for="fairways_secondary_grass">Fairways — Overseeded / Secondary <span style="font-weight:400;color:#9ca3af;">(optional)</span></label>
                            <select id="fairways_secondary_grass"><option value="">None</option></select>
                            <span class="help-text">If fairways are overseeded or a mix of grasses</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rough_grass">Rough — Primary</label>
                            <select id="rough_grass"><option value="">Select grass...</option></select>
                            <input type="text" id="rough_grass_cultivar" class="cultivar-input" placeholder="Cultivar (optional)">
                        </div>
                        <div class="form-group">
                            <label for="rough_secondary_grass">Rough — Overseeded / Secondary <span style="font-weight:400;color:#9ca3af;">(optional)</span></label>
                            <select id="rough_secondary_grass"><option value="">None</option></select>
                            <span class="help-text">If roughs are a mix or overseeded seasonally</span>
                        </div>
                    </div>

                    <h4>Acreage</h4>
                    <div class="form-row quad">
                        <div class="form-group"><label for="greens_acreage">Greens (ac)</label><input type="number" id="greens_acreage" step="0.1" min="0" placeholder="3.5"></div>
                        <div class="form-group"><label for="fairways_acreage">Fairways (ac)</label><input type="number" id="fairways_acreage" step="0.1" min="0" placeholder="28"></div>
                        <div class="form-group"><label for="tees_acreage">Tees (ac)</label><input type="number" id="tees_acreage" step="0.1" min="0" placeholder="4"></div>
                        <div class="form-group"><label for="rough_acreage">Rough (ac)</label><input type="number" id="rough_acreage" step="0.1" min="0" placeholder="45"></div>
                    </div>

                    <h4>Mowing Heights (inches)</h4>
                    <span class="help-text" style="display:block;margin-bottom:8px;">AI uses these for PGR rates, disease pressure, and cultural practice recommendations</span>
                    <div class="form-row quad">
                        <div class="form-group"><label for="mow_greens">Greens</label><input type="number" id="mow_greens" step="0.005" min="0.05" max="0.3" placeholder="0.125"></div>
                        <div class="form-group"><label for="mow_fairways">Fairways</label><input type="number" id="mow_fairways" step="0.05" min="0.2" max="2" placeholder="0.625"></div>
                        <div class="form-group"><label for="mow_tees">Tees</label><input type="number" id="mow_tees" step="0.05" min="0.15" max="1" placeholder="0.375"></div>
                        <div class="form-group"><label for="mow_rough">Rough</label><input type="number" id="mow_rough" step="0.25" min="0.5" max="5" placeholder="2.0"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== TAB 3: SPRAYERS ===== -->
        <div class="tab-panel" id="tab-sprayers">
            <div class="section">
                <h3>Sprayers</h3>
                <p style="font-size:13px;color:#6b7280;margin-bottom:16px;">Add your sprayers with GPA and tank size. Assign each to specific areas — they auto-fill in the Spray Tracker.</p>
                <div id="sprayers-list" style="margin-bottom:16px;"></div>
                <div id="sprayer-form" class="sprayer-form-panel">
                    <input type="hidden" id="sprayer-edit-id">
                    <div class="form-row">
                        <div class="form-group"><label for="sprayer-name">Sprayer Name</label><input type="text" id="sprayer-name" placeholder="e.g. Greens Sprayer"></div>
                        <div class="form-group"><label for="sprayer-nozzle">Nozzle Type <span style="color:#9ca3af;font-weight:400;">(optional)</span></label><input type="text" id="sprayer-nozzle" placeholder="e.g. AI3070, TeeJet 8002VS"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="sprayer-gpa">Spray Volume (GPA)</label><input type="number" id="sprayer-gpa" step="0.1" min="0" placeholder="e.g. 44"></div>
                        <div class="form-group"><label for="sprayer-tank">Tank Size (gallons)</label><input type="number" id="sprayer-tank" step="1" min="0" placeholder="e.g. 200"></div>
                    </div>
                    <div style="margin-bottom:12px;">
                        <label style="display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:6px;">Assigned Areas</label>
                        <div id="sprayer-areas" style="display:flex;flex-wrap:wrap;gap:8px;">
                            <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;"><input type="checkbox" value="greens" class="sprayer-area-cb"> Greens</label>
                            <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;"><input type="checkbox" value="tees" class="sprayer-area-cb"> Tees</label>
                            <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;"><input type="checkbox" value="fairways" class="sprayer-area-cb"> Fairways</label>
                            <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;"><input type="checkbox" value="rough" class="sprayer-area-cb"> Rough</label>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                        <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;"><input type="checkbox" id="sprayer-default"> Default sprayer (fallback for unassigned areas)</label>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button onclick="saveSprayer()" style="padding:8px 20px;background:#1a4d2e;color:white;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;">Save Sprayer</button>
                        <button onclick="cancelSprayerForm()" style="padding:8px 16px;background:#f3f4f6;color:#374151;border:none;border-radius:6px;font-size:13px;cursor:pointer;">Cancel</button>
                    </div>
                </div>
                <button onclick="showSprayerForm()" id="add-sprayer-btn" style="padding:10px 20px;background:#f0fdf4;color:#1a4d2e;border:1px dashed #86efac;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;width:100%;transition:background 0.2s;">+ Add Sprayer</button>
            </div>
        </div>

        <!-- ===== TAB 4: PROGRAMS ===== -->
        <div class="tab-panel" id="tab-programs">
            <div class="section">
                <h3>Programs & Budget</h3>

                <div class="form-row">
                    <div class="form-group">
                        <label for="green_speed_target">Green Speed Target (Stimpmeter)</label>
                        <input type="number" id="green_speed_target" step="0.5" min="6" max="15" placeholder="e.g. 10.5">
                        <span class="help-text">Affects PGR and cultural practice recommendations</span>
                    </div>
                    <div class="form-group">
                        <label for="budget_tier">Budget Approach</label>
                        <select id="budget_tier">
                            <option value="">Select...</option>
                            <option value="budget">Budget-Conscious (generics first)</option>
                            <option value="moderate">Moderate (cost + performance balance)</option>
                            <option value="premium">Premium (best products, any cost)</option>
                        </select>
                        <span class="help-text">AI prioritizes cost-appropriate products</span>
                    </div>
                </div>

                <h4>Annual Nitrogen Budget (lbs N / 1000 sq ft)</h4>
                <span class="help-text" style="display:block;margin-bottom:8px;">AI factors this into fertility recommendations and spray tracker N tracking</span>
                <div class="form-row quad" id="n-budget-golf" style="display:none;">
                    <div class="form-group"><label for="n_greens">Greens</label><input type="number" id="n_greens" step="0.5" min="0" max="12" placeholder="4.0"></div>
                    <div class="form-group"><label for="n_fairways">Fairways</label><input type="number" id="n_fairways" step="0.5" min="0" max="12" placeholder="3.0"></div>
                    <div class="form-group"><label for="n_tees">Tees</label><input type="number" id="n_tees" step="0.5" min="0" max="12" placeholder="3.5"></div>
                    <div class="form-group"><label for="n_rough">Rough</label><input type="number" id="n_rough" step="0.5" min="0" max="12" placeholder="2.0"></div>
                </div>
                <div class="form-row" id="n-budget-simple">
                    <div class="form-group"><label for="n_primary">Annual N Budget</label><input type="number" id="n_primary" step="0.5" min="0" max="12" placeholder="e.g. 3.0"></div>
                </div>

                <h4>Overseeding Program</h4>
                <span class="help-text" style="display:block;margin-bottom:8px;">Helps AI time herbicide apps around your overseeding window</span>
                <div class="form-row">
                    <div class="form-group">
                        <label for="overseed_grass">Overseed Grass</label>
                        <select id="overseed_grass">
                            <option value="">None / N/A</option>
                            <option value="perennial ryegrass">Perennial Ryegrass</option>
                            <option value="annual ryegrass">Annual Ryegrass</option>
                            <option value="tall fescue">Tall Fescue</option>
                            <option value="kentucky bluegrass">Kentucky Bluegrass</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="overseed_date">Target Date</label>
                        <input type="text" id="overseed_date" placeholder="e.g. Oct 1">
                    </div>
                </div>
                <div class="form-row single">
                    <div class="form-group">
                        <label for="overseed_rate">Rate (lbs seed / 1000 sq ft)</label>
                        <input type="number" id="overseed_rate" step="1" min="0" max="50" placeholder="e.g. 8">
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>Common Problems</h3>
                <span class="help-text" style="display:block;margin-bottom:12px;">Check problems you deal with regularly. AI will suggest prevention proactively.</span>

                <div class="cb-group-label">Diseases</div>
                <div class="cb-group">
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="dollar_spot"> Dollar Spot</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="brown_patch"> Brown Patch</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="pythium"> Pythium</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="anthracnose"> Anthracnose</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="fairy_ring"> Fairy Ring</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="summer_patch"> Summer Patch</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="gray_leaf_spot"> Gray Leaf Spot</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="snow_mold"> Snow Mold</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="spring_dead_spot"> Spring Dead Spot</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="take_all_patch"> Take-All Patch</label>
                </div>

                <div class="cb-group-label">Weeds</div>
                <div class="cb-group">
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="poa_annua_weed"> Poa annua</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="crabgrass"> Crabgrass</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="goosegrass"> Goosegrass</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="sedge"> Sedge</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="clover"> Clover</label>
                </div>

                <div class="cb-group-label">Insects & Other</div>
                <div class="cb-group">
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="white_grubs"> White Grubs</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="armyworms"> Armyworms</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="nematodes"> Nematodes</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="algae"> Algae</label>
                    <label class="cb-label"><input type="checkbox" class="problem-cb" value="moss"> Moss</label>
                </div>
            </div>

            <div class="section">
                <h3>Preferred Products</h3>
                <div class="form-row single">
                    <div class="form-group">
                        <label for="preferred_products">Products or Brands You Prefer</label>
                        <textarea id="preferred_products" rows="2" placeholder="e.g. Heritage, Primo Maxx, Syngenta products, chlorothalonil"></textarea>
                        <span class="help-text">Comma-separated. AI will favor these when making recommendations.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== TAB 5: SOIL & WATER ===== -->
        <div class="tab-panel" id="tab-soil-water">
            <div class="section">
                <h3>Soil & Water</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="soil_type">Soil Type</label>
                        <select id="soil_type">
                            <option value="">Select soil...</option>
                            <option value="USGA sand-based">USGA Sand-Based</option>
                            <option value="native soil">Native Soil</option>
                            <option value="push-up">Push-Up</option>
                            <option value="sand-capped">Sand-Capped</option>
                            <option value="clay">Clay</option>
                            <option value="loam">Loam</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="irrigation_source">Irrigation Source</label>
                        <select id="irrigation_source">
                            <option value="">Select source...</option>
                            <option value="potable">Potable Water</option>
                            <option value="reclaimed">Reclaimed / Effluent</option>
                            <option value="well">Well Water</option>
                            <option value="pond">Pond / Lake</option>
                            <option value="river">River / Stream</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="soil_ph">Soil pH <span style="font-weight:400;color:#9ca3af;font-size:12px;">(from soil test)</span></label>
                        <input type="number" id="soil_ph" step="0.1" min="3" max="10" placeholder="e.g. 6.5">
                    </div>
                    <div class="form-group">
                        <label for="soil_om">Organic Matter % <span style="font-weight:400;color:#9ca3af;font-size:12px;">(from soil test)</span></label>
                        <input type="number" id="soil_om" step="0.1" min="0" max="100" placeholder="e.g. 2.5">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="water_ph">Water pH</label>
                        <input type="number" id="water_ph" step="0.1" min="3" max="10" placeholder="e.g. 7.2">
                    </div>
                    <div class="form-group">
                        <label for="water_ec">Water EC / Salinity <span style="font-weight:400;color:#9ca3af;font-size:12px;">(dS/m)</span></label>
                        <input type="number" id="water_ec" step="0.01" min="0" placeholder="e.g. 1.2">
                    </div>
                </div>
                <div class="form-row single">
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" placeholder="Anything else the AI should know — problem areas, budget constraints, environmental concerns, etc."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Context preview card -->
        <div class="context-card" id="context-card">
            <h3 onclick="toggleContextPreview()">
                What the AI Sees <span style="font-weight:400;color:#6b7280;font-size:13px;">(your profile context)</span>
                <span class="chevron">&#9660;</span>
            </h3>
            <div class="context-body">
                <div id="ai-context-text" class="context-text">Save your profile to see the AI context.</div>
                <p style="font-size:11px;color:#9ca3af;margin-top:8px;">This text is injected into every AI conversation. Save to update.</p>
            </div>
        </div>

        <!-- Save bar -->
        <div class="save-bar">
            <button class="save-btn" id="save-btn" onclick="saveProfile()">Save Profile</button>
            <span class="save-toast" id="save-toast">&#10003; Profile saved</span>
            <a href="/" class="go-chat-btn" id="go-chat-btn">Go to Chat &rarr;</a>
        </div>
        <div class="skip-link" id="skip-link">
            <a href="/">Skip for now — go to chat &rarr;</a>
        </div>
    </div>

    <script>
    // =========================================================================
    // Data
    // =========================================================================
    const states = [
        'Alabama','Alaska','Arizona','Arkansas','California','Colorado','Connecticut',
        'Delaware','Florida','Georgia','Hawaii','Idaho','Illinois','Indiana','Iowa',
        'Kansas','Kentucky','Louisiana','Maine','Maryland','Massachusetts','Michigan',
        'Minnesota','Mississippi','Missouri','Montana','Nebraska','Nevada','New Hampshire',
        'New Jersey','New Mexico','New York','North Carolina','North Dakota','Ohio',
        'Oklahoma','Oregon','Pennsylvania','Rhode Island','South Carolina','South Dakota',
        'Tennessee','Texas','Utah','Vermont','Virginia','Washington','West Virginia',
        'Wisconsin','Wyoming'
    ];

    const stateClimateZones = {
        'Alabama':'7b-8a','Alaska':'4a-7b','Arizona':'9a-10b','Arkansas':'7a-8a','California':'8a-10b',
        'Colorado':'5a-6b','Connecticut':'6a-6b','Delaware':'7a-7b','Florida':'9a-10b','Georgia':'7b-9a',
        'Hawaii':'10b-12a','Idaho':'5a-6b','Illinois':'5b-6b','Indiana':'5b-6b','Iowa':'5a-5b',
        'Kansas':'5b-6b','Kentucky':'6a-7a','Louisiana':'8a-9a','Maine':'4a-5b','Maryland':'6b-7b',
        'Massachusetts':'5b-6b','Michigan':'5a-6a','Minnesota':'3b-4b','Mississippi':'7b-8b',
        'Missouri':'5b-7a','Montana':'4a-5b','Nebraska':'4b-5b','Nevada':'6a-9b','New Hampshire':'4b-5b',
        'New Jersey':'6b-7a','New Mexico':'6a-8b','New York':'4b-7a','North Carolina':'7a-8a',
        'North Dakota':'3b-4b','Ohio':'5b-6b','Oklahoma':'6b-7b','Oregon':'6a-9b','Pennsylvania':'5b-7a',
        'Rhode Island':'6a-6b','South Carolina':'7b-8b','South Dakota':'4a-5a','Tennessee':'6b-7b',
        'Texas':'7a-9b','Utah':'5a-7b','Vermont':'4a-5a','Virginia':'6a-7b','Washington':'5b-8b',
        'West Virginia':'5b-6b','Wisconsin':'4a-5b','Wyoming':'4a-5b'
    };

    const allGrassTypes = [
        { value: 'bentgrass', label: 'Bentgrass' },
        { value: 'hybrid bermudagrass', label: 'Hybrid Bermudagrass' },
        { value: 'bermudagrass', label: 'Common Bermudagrass' },
        { value: 'poa annua', label: 'Poa annua' },
        { value: 'kentucky bluegrass', label: 'Kentucky Bluegrass' },
        { value: 'tall fescue', label: 'Tall Fescue' },
        { value: 'perennial ryegrass', label: 'Perennial Ryegrass' },
        { value: 'annual ryegrass', label: 'Annual Ryegrass' },
        { value: 'zoysiagrass', label: 'Zoysiagrass' },
        { value: 'paspalum', label: 'Paspalum' },
        { value: 'st. augustinegrass', label: 'St. Augustinegrass' },
        { value: 'centipedegrass', label: 'Centipedegrass' },
        { value: 'bahiagrass', label: 'Bahiagrass' },
        { value: 'fine fescue', label: 'Fine Fescue' },
        { value: 'buffalograss', label: 'Buffalograss' },
        { value: 'kikuyugrass', label: 'Kikuyugrass' },
        { value: 'bluegrass-ryegrass mix', label: 'Bluegrass/Ryegrass Mix' },
        { value: 'bluegrass-fescue mix', label: 'Bluegrass/Fescue Mix' },
        { value: 'fescue-ryegrass mix', label: 'Fescue/Ryegrass Mix' },
        { value: 'native mix', label: 'Native / Low-Input Mix' }
    ];
    const greensGrassTypes = ['bentgrass','hybrid bermudagrass','bermudagrass','poa annua','paspalum','zoysiagrass'];
    const fairwaysGrassTypes = [
        'hybrid bermudagrass','bermudagrass','bentgrass','kentucky bluegrass',
        'perennial ryegrass','zoysiagrass','tall fescue','paspalum','poa annua',
        'kikuyugrass','bluegrass-ryegrass mix','bluegrass-fescue mix','fine fescue'
    ];
    const roughGrassTypes = [
        'kentucky bluegrass','tall fescue','perennial ryegrass','hybrid bermudagrass',
        'bermudagrass','fine fescue','zoysiagrass','st. augustinegrass','bahiagrass',
        'buffalograss','kikuyugrass','bluegrass-ryegrass mix','bluegrass-fescue mix',
        'fescue-ryegrass mix','native mix'
    ];
    // Secondary/overseeded grass options for fairways and roughs
    const overseedGrassTypes = [
        'perennial ryegrass','annual ryegrass','tall fescue','kentucky bluegrass',
        'fine fescue','bluegrass-ryegrass mix','fescue-ryegrass mix'
    ];

    // =========================================================================
    // Initialization
    // =========================================================================
    function populateGrassSelect(selectId, filterList) {
        const sel = document.getElementById(selectId);
        const currentVal = sel.value;
        while (sel.options.length > 1) sel.remove(1);
        const grassList = filterList ? allGrassTypes.filter(g => filterList.includes(g.value)) : allGrassTypes;
        grassList.forEach(g => { const opt = document.createElement('option'); opt.value = g.value; opt.textContent = g.label; sel.appendChild(opt); });
        if (currentVal) sel.value = currentVal;
    }

    // Populate state dropdown
    const stateSelect = document.getElementById('state');
    states.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.textContent = s; stateSelect.appendChild(opt); });

    // Auto-fill climate zone when state changes
    stateSelect.addEventListener('change', function() {
        const zone = stateClimateZones[this.value];
        const czEl = document.getElementById('climate_zone');
        if (zone && !czEl.value) czEl.value = zone;
    });

    // Populate all grass dropdowns
    populateGrassSelect('primary_grass', null);
    populateGrassSelect('greens_grass', greensGrassTypes);
    populateGrassSelect('fairways_grass', fairwaysGrassTypes);
    populateGrassSelect('rough_grass', roughGrassTypes);
    populateGrassSelect('tees_grass', fairwaysGrassTypes);
    populateGrassSelect('fairways_secondary_grass', overseedGrassTypes);
    populateGrassSelect('rough_secondary_grass', overseedGrassTypes);

    // =========================================================================
    // Tabs
    // =========================================================================
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
    });

    // =========================================================================
    // Facility type toggle
    // =========================================================================
    function onFacilityTypeChange() {
        const isGolf = document.getElementById('turf_type').value === 'golf_course';
        document.getElementById('golf-grass-section').style.display = isGolf ? 'block' : 'none';
        document.getElementById('primary-grass-group').style.display = isGolf ? 'none' : 'block';
        document.getElementById('n-budget-golf').style.display = isGolf ? 'grid' : 'none';
        document.getElementById('n-budget-simple').style.display = isGolf ? 'none' : 'grid';
        updateCompleteness();
    }

    // =========================================================================
    // Completeness indicator
    // =========================================================================
    const coreFields = ['state', 'role', 'turf_type'];
    function getCoreGrassFields() {
        return document.getElementById('turf_type').value === 'golf_course' ? ['greens_grass'] : ['primary_grass'];
    }
    function fieldHasValue(id) { const el = document.getElementById(id); return el && el.value && el.value.trim() !== ''; }

    function updateCompleteness() {
        let score = 0, max = 0;
        // Core (required)
        [...coreFields, ...getCoreGrassFields()].forEach(f => { max += 30; if (fieldHasValue(f)) score += 30; });
        // Valuable
        [() => fieldHasValue('soil_type'), () => sprayers.length > 0].forEach(fn => { max += 10; if (fn()) score += 10; });
        // Check mowing
        max += 10;
        const isGolf = document.getElementById('turf_type').value === 'golf_course';
        if (isGolf ? fieldHasValue('mow_greens') : fieldHasValue('mow_primary')) score += 10;
        // Bonus
        ['green_speed_target', 'budget_tier'].forEach(f => { max += 5; if (fieldHasValue(f)) score += 5; });
        max += 5; if (document.querySelectorAll('.problem-cb:checked').length > 0) score += 5;

        const pct = Math.round((score / max) * 100);
        const bar = document.getElementById('completeness-bar');
        const label = document.getElementById('completeness-label');
        bar.style.width = pct + '%';
        bar.style.background = pct >= 100 ? '#16a34a' : pct >= 60 ? '#eab308' : '#ef4444';
        if (pct >= 90) {
            label.textContent = 'Excellent — AI answers are fully personalized';
        } else if (pct >= 60) {
            label.textContent = pct + '% — Good foundation. Add mowing, soil, or programs for better answers.';
        } else {
            const missing = [...coreFields, ...getCoreGrassFields()].filter(f => !fieldHasValue(f)).map(f => f.replace(/_/g,' '));
            label.textContent = pct + '% — Add: ' + (missing.length ? missing.join(', ') : 'more details');
        }
    }

    // Update completeness when key fields change (both change and input for real-time)
    ['state','role','turf_type','primary_grass','greens_grass','soil_type','green_speed_target','budget_tier','mow_greens','mow_primary'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('change', updateCompleteness);
            el.addEventListener('input', updateCompleteness);
        }
    });

    // =========================================================================
    // Profile save/load
    // =========================================================================
    const simpleFields = [
        'course_name', 'city', 'state', 'primary_grass', 'role', 'turf_type',
        'greens_grass', 'fairways_grass', 'rough_grass', 'tees_grass',
        'soil_type', 'irrigation_source', 'notes',
        'primary_grass_cultivar', 'greens_grass_cultivar', 'fairways_grass_cultivar',
        'rough_grass_cultivar', 'tees_grass_cultivar',
        'greens_acreage', 'fairways_acreage', 'rough_acreage', 'tees_acreage',
        'soil_ph', 'soil_om', 'water_ph', 'water_ec',
        'green_speed_target', 'budget_tier', 'climate_zone',
        'fairways_secondary_grass', 'rough_secondary_grass'
    ];

    function buildProfileData() {
        const data = {};
        simpleFields.forEach(f => { const el = document.getElementById(f); if (el) data[f] = el.value || null; });

        // Pack secondary grasses into secondary_grasses JSON
        const secGrasses = {};
        if (data.fairways_secondary_grass) secGrasses.fairways = data.fairways_secondary_grass;
        if (data.rough_secondary_grass) secGrasses.rough = data.rough_secondary_grass;
        data.secondary_grasses = Object.keys(secGrasses).length ? JSON.stringify(secGrasses) : null;
        // Remove the individual keys (not DB columns)
        delete data.fairways_secondary_grass;
        delete data.rough_secondary_grass;

        // Mowing heights as JSON
        const isGolf = document.getElementById('turf_type').value === 'golf_course';
        if (isGolf) {
            data.mowing_heights = JSON.stringify({
                greens: document.getElementById('mow_greens').value || null,
                fairways: document.getElementById('mow_fairways').value || null,
                tees: document.getElementById('mow_tees').value || null,
                rough: document.getElementById('mow_rough').value || null
            });
        } else {
            const mh = document.getElementById('mow_primary').value;
            data.mowing_heights = mh ? JSON.stringify({primary: mh}) : null;
        }

        // N budget as JSON
        if (isGolf) {
            data.annual_n_budget = JSON.stringify({
                greens: document.getElementById('n_greens').value || null,
                fairways: document.getElementById('n_fairways').value || null,
                tees: document.getElementById('n_tees').value || null,
                rough: document.getElementById('n_rough').value || null
            });
        } else {
            const nb = document.getElementById('n_primary').value;
            data.annual_n_budget = nb ? JSON.stringify({primary: nb}) : null;
        }

        // Common problems
        const problems = [];
        document.querySelectorAll('.problem-cb:checked').forEach(cb => problems.push(cb.value));
        data.common_problems = JSON.stringify(problems);

        // Preferred products
        const prodText = (document.getElementById('preferred_products').value || '').trim();
        data.preferred_products = JSON.stringify(prodText ? prodText.split(',').map(s => s.trim()).filter(Boolean) : []);

        // Overseeding
        data.overseeding_program = JSON.stringify({
            grass: document.getElementById('overseed_grass').value || null,
            date: document.getElementById('overseed_date').value || null,
            rate: document.getElementById('overseed_rate').value || null
        });

        return data;
    }

    async function loadProfile() {
        try {
            const resp = await fetch('/api/profile');
            if (!resp.ok) return;
            const data = await resp.json();

            // Simple fields
            simpleFields.forEach(f => { const el = document.getElementById(f); if (el && data[f]) el.value = data[f]; });

            // Secondary grasses (JSON object → individual selects)
            const secGrasses = data.secondary_grasses;
            if (secGrasses && typeof secGrasses === 'object') {
                if (secGrasses.fairways) document.getElementById('fairways_secondary_grass').value = secGrasses.fairways;
                if (secGrasses.rough) document.getElementById('rough_secondary_grass').value = secGrasses.rough;
            }

            // Mowing heights (JSON object)
            const mh = data.mowing_heights;
            if (mh && typeof mh === 'object') {
                if (mh.greens) document.getElementById('mow_greens').value = mh.greens;
                if (mh.fairways) document.getElementById('mow_fairways').value = mh.fairways;
                if (mh.tees) document.getElementById('mow_tees').value = mh.tees;
                if (mh.rough) document.getElementById('mow_rough').value = mh.rough;
                if (mh.primary) document.getElementById('mow_primary').value = mh.primary;
            }

            // N budget (JSON object)
            const nb = data.annual_n_budget;
            if (nb && typeof nb === 'object') {
                if (nb.greens) document.getElementById('n_greens').value = nb.greens;
                if (nb.fairways) document.getElementById('n_fairways').value = nb.fairways;
                if (nb.tees) document.getElementById('n_tees').value = nb.tees;
                if (nb.rough) document.getElementById('n_rough').value = nb.rough;
                if (nb.primary) document.getElementById('n_primary').value = nb.primary;
            }

            // Common problems (JSON array)
            const problems = data.common_problems;
            if (Array.isArray(problems)) {
                problems.forEach(p => {
                    const cb = document.querySelector(`.problem-cb[value="${p}"]`);
                    if (cb) cb.checked = true;
                });
            }

            // Preferred products (JSON array → comma string)
            const prods = data.preferred_products;
            if (Array.isArray(prods) && prods.length) {
                document.getElementById('preferred_products').value = prods.join(', ');
            }

            // Overseeding (JSON object)
            const os = data.overseeding_program;
            if (os && typeof os === 'object') {
                if (os.grass) document.getElementById('overseed_grass').value = os.grass;
                if (os.date) document.getElementById('overseed_date').value = os.date;
                if (os.rate) document.getElementById('overseed_rate').value = os.rate;
            }

            onFacilityTypeChange();
            updateCompleteness();
            loadContextPreview();
        } catch (e) {
            console.error('Failed to load profile', e);
        }
    }

    async function saveProfile() {
        const btn = document.getElementById('save-btn');
        const toast = document.getElementById('save-toast');
        btn.disabled = true;
        btn.textContent = 'Saving...';

        try {
            const resp = await fetch('/api/profile', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(buildProfileData())
            });
            if (resp.ok) {
                toast.style.display = 'inline';
                btn.textContent = 'Saved';
                updateCompleteness();
                loadContextPreview();
                if (window.location.search.includes('setup=1')) {
                    document.getElementById('go-chat-btn').style.display = 'inline-block';
                }
                setTimeout(() => { toast.style.display = 'none'; btn.disabled = false; btn.textContent = 'Save Profile'; }, 2500);
            } else {
                alert('Failed to save profile');
                btn.disabled = false; btn.textContent = 'Save Profile';
            }
        } catch (e) {
            alert('Failed to save profile');
            btn.disabled = false; btn.textContent = 'Save Profile';
        }
    }

    // =========================================================================
    // Context preview
    // =========================================================================
    function toggleContextPreview() {
        document.getElementById('context-card').classList.toggle('open');
    }

    async function loadContextPreview() {
        try {
            const resp = await fetch('/api/profile/context-preview');
            if (resp.ok) {
                const data = await resp.json();
                document.getElementById('ai-context-text').textContent = data.context || 'No profile data yet. Fill in fields above and save.';
            }
        } catch (e) {}
    }

    // =========================================================================
    // Setup mode
    // =========================================================================
    if (window.location.search.includes('setup=1')) {
        document.getElementById('welcome-banner').style.display = 'block';
        document.getElementById('skip-link').style.display = 'block';
    }

    loadProfile();

    // =========================================================================
    // Sprayer Management
    // =========================================================================
    let sprayers = [];

    async function loadSprayers() {
        try {
            const resp = await fetch('/api/sprayers');
            if (resp.ok) { sprayers = await resp.json(); renderSprayers(); updateCompleteness(); }
        } catch (e) { console.error('Failed to load sprayers', e); }
    }

    function renderSprayers() {
        const container = document.getElementById('sprayers-list');
        if (!sprayers.length) {
            container.innerHTML = '<div style="text-align:center;padding:16px;color:#9ca3af;font-size:13px;">No sprayers configured yet. Add one below.</div>';
            return;
        }
        container.innerHTML = sprayers.map(s => {
            const areas = (Array.isArray(s.areas) ? s.areas : []).map(a => a.charAt(0).toUpperCase() + a.slice(1));
            const areaStr = areas.length ? areas.join(', ') : '<span style="color:#9ca3af">No areas assigned</span>';
            return `<div class="sprayer-card">
                <div class="sprayer-card-body">
                    <div class="sprayer-name">${escapeHtml(s.name)}${s.is_default ? '<span class="sprayer-default-badge">DEFAULT</span>' : ''}</div>
                    <div class="sprayer-detail">${s.gpa} GPA &middot; ${s.tank_size} gal tank${s.nozzle_type ? ' &middot; ' + escapeHtml(s.nozzle_type) : ''}</div>
                    <div class="sprayer-detail">Areas: ${areaStr}</div>
                </div>
                <button onclick="editSprayer(${s.id})" class="sprayer-link" style="color:#2d7a4a;">Edit</button>
                <button onclick="deleteSprayer(${s.id})" class="sprayer-link" style="color:#dc2626;">Delete</button>
            </div>`;
        }).join('');
    }

    function showSprayerForm() {
        document.getElementById('sprayer-form').style.display = 'block';
        document.getElementById('add-sprayer-btn').style.display = 'none';
        document.getElementById('sprayer-edit-id').value = '';
        ['sprayer-name','sprayer-gpa','sprayer-tank','sprayer-nozzle'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('sprayer-default').checked = false;
        document.querySelectorAll('.sprayer-area-cb').forEach(cb => cb.checked = false);
        document.getElementById('sprayer-name').focus();
    }

    function cancelSprayerForm() {
        document.getElementById('sprayer-form').style.display = 'none';
        document.getElementById('add-sprayer-btn').style.display = 'block';
    }

    function editSprayer(id) {
        const s = sprayers.find(x => x.id === id);
        if (!s) return;
        document.getElementById('sprayer-form').style.display = 'block';
        document.getElementById('add-sprayer-btn').style.display = 'none';
        document.getElementById('sprayer-edit-id').value = s.id;
        document.getElementById('sprayer-name').value = s.name;
        document.getElementById('sprayer-gpa').value = s.gpa;
        document.getElementById('sprayer-tank').value = s.tank_size;
        document.getElementById('sprayer-nozzle').value = s.nozzle_type || '';
        document.getElementById('sprayer-default').checked = !!s.is_default;
        const areas = Array.isArray(s.areas) ? s.areas : [];
        document.querySelectorAll('.sprayer-area-cb').forEach(cb => { cb.checked = areas.includes(cb.value); });
    }

    async function saveSprayer() {
        const name = document.getElementById('sprayer-name').value.trim();
        const gpa = parseFloat(document.getElementById('sprayer-gpa').value);
        const tankSize = parseFloat(document.getElementById('sprayer-tank').value);
        if (!name) { alert('Sprayer name is required'); return; }
        if (!gpa || gpa <= 0) { alert('GPA is required'); return; }
        if (!tankSize || tankSize <= 0) { alert('Tank size is required'); return; }
        const areas = [];
        document.querySelectorAll('.sprayer-area-cb:checked').forEach(cb => areas.push(cb.value));
        const data = { name, gpa, tank_size: tankSize, nozzle_type: document.getElementById('sprayer-nozzle').value.trim() || null, areas, is_default: document.getElementById('sprayer-default').checked };
        const editId = document.getElementById('sprayer-edit-id').value;
        if (editId) data.id = parseInt(editId);
        try {
            const resp = await fetch('/api/sprayers', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            if (resp.ok) { cancelSprayerForm(); await loadSprayers(); } else { const err = await resp.json(); alert(err.error || 'Failed to save sprayer'); }
        } catch (e) { alert('Failed to save sprayer'); }
    }

    async function deleteSprayer(id) {
        if (!confirm('Delete this sprayer?')) return;
        try { const resp = await fetch(`/api/sprayers/${id}`, { method: 'DELETE' }); if (resp.ok) await loadSprayers(); } catch (e) {}
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    loadSprayers();
    </script>
</body>
</html>
