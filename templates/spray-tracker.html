<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a4d2e">
    <title>Spray Tracker - Greenside AI</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='8' fill='%231a4d2e'/%3E%3Ctext x='16' y='22' font-size='18' font-weight='700' text-anchor='middle' fill='white' font-family='system-ui'%3EG%3C/text%3E%3C/svg%3E">
    <link rel="stylesheet" href="/static/css/spray-tracker.css">
</head>
<body>
    <header>
        <div class="header-content">
            <a href="/" class="logo">Greenside AI</a>
            <div class="nav-links">
                <a href="/">Chat</a>
                <a href="/spray-tracker" class="active">Spray Tracker</a>
                <a href="/resources">Resources</a>
                <a href="/profile">Profile</a>
            </div>
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">â˜°</button>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <h1>Spray Tracker</h1>
            <p>Log applications, auto-calculate rates, and track nutrients</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('log')">Log Application</button>
            <button class="tab" onclick="switchTab('history')">History</button>
            <button class="tab" onclick="switchTab('nutrients')">Nutrients</button>
            <button class="tab" onclick="switchTab('library')">Inventory</button>
        </div>

        <!-- TAB 1: Log Application -->
        <div class="tab-panel active" id="tab-log">
            <div class="section">
                <h3>Application Details</h3>
                <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label for="spray-date">Date</label>
                        <input type="date" id="spray-date">
                    </div>
                    <div class="form-group">
                        <label for="spray-area">Area</label>
                        <select id="spray-area" onchange="onAreaChange()">
                            <option value="">Select area...</option>
                            <option value="greens">Greens</option>
                            <option value="fairways">Fairways</option>
                            <option value="tees">Tees</option>
                            <option value="rough">Rough</option>
                        </select>
                        <div class="hint" id="area-acreage-hint"></div>
                    </div>
                    <div class="form-group">
                        <label for="application-method">Method</label>
                        <select id="application-method" onchange="onMethodChange()">
                            <option value="spray_tank">Sprayer</option>
                            <option value="push_spreader">Push Spreader</option>
                            <option value="ride_on_spreader">Ride-On Spreader</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="spray-sprayer">Sprayer</label>
                        <select id="spray-sprayer" onchange="onSprayerChange()">
                            <option value="">Select sprayer...</option>
                        </select>
                        <div class="hint" id="sprayer-info-hint"></div>
                    </div>
                </div>

                <!-- Equipment Info Row -->
                <div class="equip-info-row" id="equip-info-row">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:13px;color:#374151;" id="equip-summary">Select a sprayer to see equipment info</span>
                    </div>
                    <div class="equip-stat" id="equip-tanks-stat" style="display:none;">
                        <div class="equip-label">Tanks</div>
                        <div class="equip-value"><input type="number" id="equip-tanks" value="" min="1" step="1" placeholder="â€”" oninput="onTanksInput()"></div>
                    </div>
                    <div class="equip-stat" id="equip-acretank-stat" style="display:none;">
                        <div class="equip-label">Acres / Tank</div>
                        <div class="equip-value" id="equip-acres-per-tank">â€”</div>
                    </div>
                </div>

                <!-- Product Table (TurfCloud-inspired) -->
                <div style="margin-top:20px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span style="font-size:13px;font-weight:700;color:#374151;text-transform:uppercase;letter-spacing:0.5px;">Products</span>
                            <span style="font-size:11px;color:#9ca3af;" id="inventory-count"></span>
                        </div>
                        <a href="#" onclick="openCustomProductModal(); return false;" style="color:#2d7a4a;font-size:12px;font-weight:600;">+ Custom Product</a>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
                        <select id="template-select" onchange="loadTemplate()" style="padding:5px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:12px;color:#374151;min-width:180px;">
                            <option value="">Load template...</option>
                        </select>
                        <button onclick="saveAsTemplate()" style="padding:5px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:12px;cursor:pointer;background:white;color:#374151;">Save as Template</button>
                        <button onclick="deleteCurrentTemplate()" id="delete-template-btn" style="padding:5px 8px;border:none;font-size:12px;cursor:pointer;background:none;color:#dc2626;display:none;">Delete</button>
                    </div>
                    <div class="product-table-wrapper">
                        <table class="product-table" id="product-table">
                            <thead id="product-table-head">
                                <tr>
                                    <th>Product Name</th>
                                    <th>Rate</th>
                                    <th>Unit</th>
                                    <th id="pt-col4-head">Product Per Tank</th>
                                    <th>Total Product</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="product-table-body">
                                <!-- Product rows rendered by JS -->
                            </tbody>
                        </table>
                    </div>
                    <button type="button" class="add-product-btn" onclick="addProductRow()">+ Add Product to Application</button>
                </div>

                <!-- Area acreage override -->
                <div class="form-row single" style="margin-top:16px;">
                    <div class="form-group">
                        <label for="spray-acreage-override">Area Acreage (override)</label>
                        <input type="number" id="spray-acreage-override" step="0.01" placeholder="From profile" oninput="recalcAllRows()">
                        <div class="hint">Leave blank to use profile acreage</div>
                    </div>
                </div>

                <!-- Live Nutrient Calculations -->
                <div class="calc-display hidden" id="calc-display">
                    <div class="calc-row">
                        <span class="label" id="calc-summary-label">Application Summary</span>
                        <span class="value" id="calc-summary-value">â€”</span>
                    </div>
                    <div class="calc-row" id="calc-carrier-row" style="display:none">
                        <span class="label">Total Amount</span>
                        <span class="value" id="calc-carrier-value">â€”</span>
                    </div>
                    <div id="calc-nutrients-section" style="display:none">
                        <table class="nutrient-calc-table">
                            <thead>
                                <tr>
                                    <th>Nutrient</th>
                                    <th>Per 1000 ftÂ²</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="calc-nutrients-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Weather section -->
            <div class="section">
                <h3>Weather & Notes</h3>
                <div class="form-row triple">
                    <div class="form-group">
                        <label for="weather-temp">Temperature (Â°F)</label>
                        <input type="number" id="weather-temp" placeholder="e.g. 75">
                    </div>
                    <div class="form-group">
                        <label for="weather-wind">Wind</label>
                        <input type="text" id="weather-wind" placeholder="e.g. 5-10 mph">
                    </div>
                    <div class="form-group">
                        <label for="weather-conditions">Conditions</label>
                        <select id="weather-conditions">
                            <option value="">Select...</option>
                            <option value="sunny">Sunny</option>
                            <option value="partly_cloudy">Partly Cloudy</option>
                            <option value="overcast">Overcast</option>
                            <option value="light_rain">Light Rain</option>
                            <option value="humid">Humid</option>
                        </select>
                    </div>
                </div>
                <div class="form-row single">
                    <div class="form-group">
                        <label for="spray-notes">Notes</label>
                        <textarea id="spray-notes" placeholder="Optional notes about this application..."></textarea>
                    </div>
                </div>
            </div>

            <div id="validation-warnings" style="margin-bottom:8px;"></div>
            <button class="submit-btn" id="submit-spray-btn" onclick="submitSpray()">Log Application</button>
            <div class="success-msg" id="success-msg">âœ… <span id="success-text">Application logged successfully</span></div>
            <div class="error-msg" id="error-msg"></div>
        </div>

        <!-- TAB 2: History -->
        <div class="tab-panel" id="tab-history">
            <div class="section">
                <div class="filter-bar">
                    <select id="filter-year" onchange="loadHistory()">
                        <option value="">All Years</option>
                    </select>
                    <select id="filter-area" onchange="loadHistory()">
                        <option value="">All Areas</option>
                        <option value="greens">Greens</option>
                        <option value="fairways">Fairways</option>
                        <option value="tees">Tees</option>
                        <option value="rough">Rough</option>
                    </select>
                </div>

                <div id="history-content">
                    <div class="empty-state">
                        <div class="icon">ðŸ“‹</div>
                        <p>No applications logged yet</p>
                    </div>
                </div>

                <div style="text-align:center;margin-top:16px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
                    <button class="report-btn" onclick="downloadSprayReport()">Download Spray Report PDF</button>
                    <button class="report-btn" onclick="downloadCsv()" style="background:#f9fafb;color:#374151;border:1px solid #d1d5db;">Export CSV</button>
                </div>
            </div>
        </div>

        <!-- TAB 3: Nutrients -->
        <div class="tab-panel" id="tab-nutrients">
            <div class="filter-bar" style="margin-bottom:20px;">
                <select id="nutrient-year" onchange="loadNutrients()">
                </select>
            </div>

            <div id="nutrient-content">
                <div class="empty-state">
                    <div class="icon">ðŸ§ª</div>
                    <p>Log fertilizer applications to see nutrient tracking</p>
                </div>
            </div>

            <div id="monthly-breakdown" style="display:none;margin-top:24px;background:white;border:1px solid #e5e7eb;border-radius:10px;padding:16px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <h3 style="font-size:15px;font-weight:700;color:#374151;margin:0;">Monthly N Applied (lbs/1000 ftÂ²)</h3>
                    <select id="compare-year" onchange="loadMonthlyNutrients()" style="padding:4px 8px;border:1px solid #d1d5db;border-radius:6px;font-size:12px;">
                        <option value="">Compare year...</option>
                    </select>
                </div>
                <div id="monthly-chart"></div>
            </div>

            <div style="text-align:center;margin-top:20px;display:flex;justify-content:center;gap:12px;flex-wrap:wrap;">
                <button class="report-btn" onclick="downloadNutrientReport()">Download Nutrient Report PDF</button>
                <button class="report-btn" onclick="downloadSeasonalReport()">Download Full Season Report PDF</button>
            </div>
        </div>

        <!-- TAB 4: Inventory -->
        <div class="tab-panel" id="tab-library">
            <div class="section">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h3 style="margin:0;">My Inventory</h3>
                    <span style="font-size:13px;color:#6b7280;" id="library-inv-count-label"><span id="library-inv-count">0</span> products</span>
                </div>

                <!-- Add products search -->
                <div style="margin-bottom:20px;">
                    <label style="font-size:13px;font-weight:600;color:#374151;display:block;margin-bottom:6px;">Add Products</label>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <div style="flex:1;min-width:200px;position:relative;">
                            <input type="text" id="inv-add-search" placeholder="Search all products to add..."
                                oninput="onInvAddSearch()"
                                onfocus="onInvAddSearch()"
                                onblur="setTimeout(() => document.getElementById('inv-add-dropdown').style.display='none', 200)"
                                style="width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;box-sizing:border-box;">
                            <div id="inv-add-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;max-height:300px;overflow-y:auto;background:white;border:1px solid #d1d5db;border-top:none;border-radius:0 0 6px 6px;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,0.1);"></div>
                        </div>
                    </div>
                    <p style="color:#9ca3af;font-size:12px;margin:6px 0 0;">Search by product name, brand, or active ingredient. Products you spray are also auto-added.</p>
                </div>

                <!-- Category filter for inventory display -->
                <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center;">
                    <label style="font-size:12px;color:#6b7280;">Filter:</label>
                    <select id="inv-category-filter" onchange="renderInventoryList()" style="padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:12px;">
                        <option value="">All Categories</option>
                        <option value="fungicide">Fungicide</option>
                        <option value="herbicide">Herbicide</option>
                        <option value="insecticide">Insecticide</option>
                        <option value="pgr">PGR</option>
                        <option value="nematicide">Nematicide</option>
                        <option value="fertilizer">Fertilizer</option>
                        <option value="wetting_agent">Wetting Agent</option>
                        <option value="soil_amendment">Soil Amendment</option>
                        <option value="biostimulant">Biostimulant</option>
                        <option value="adjuvant">Adjuvant</option>
                        <option value="colorant">Colorant</option>
                    </select>
                </div>

                <!-- Inventory list -->
                <div id="inv-list" style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;"></div>
            </div>
        </div>
    </div>

    <!-- Custom Product Modal -->
    <div class="modal-overlay" id="custom-product-modal">
        <div class="modal">
            <h2>Add Custom Product</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Product Name *</label>
                    <input type="text" id="cp-name" placeholder="e.g. My Custom 20-0-10">
                </div>
                <div class="form-group">
                    <label>Brand</label>
                    <input type="text" id="cp-brand" placeholder="e.g. Custom Blend">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Type</label>
                    <select id="cp-type">
                        <option value="fertilizer">Fertilizer</option>
                        <option value="fungicide">Fungicide</option>
                        <option value="herbicide">Herbicide</option>
                        <option value="insecticide">Insecticide</option>
                        <option value="pgr">PGR</option>
                        <option value="wetting_agent">Wetting Agent</option>
                        <option value="soil_amendment">Soil Amendment</option>
                        <option value="biostimulant">Biostimulant</option>
                        <option value="colorant">Colorant</option>
                        <option value="adjuvant">Adjuvant</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Form</label>
                    <select id="cp-form">
                        <option value="granular">Granular</option>
                        <option value="liquid">Liquid</option>
                    </select>
                </div>
            </div>
            <div class="form-row triple">
                <div class="form-group">
                    <label>N (%)</label>
                    <input type="number" id="cp-n" step="0.1" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Pâ‚‚Oâ‚… (%)</label>
                    <input type="number" id="cp-p" step="0.1" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Kâ‚‚O (%)</label>
                    <input type="number" id="cp-k" step="0.1" placeholder="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Default Rate</label>
                    <input type="number" id="cp-rate" step="0.1" placeholder="e.g. 5">
                </div>
                <div class="form-group">
                    <label>Rate Unit</label>
                    <select id="cp-rate-unit">
                        <option value="lbs/1000 sq ft">lbs / 1000 ftÂ²</option>
                        <option value="fl oz/1000 sq ft">fl oz / 1000 ftÂ²</option>
                        <option value="gal/1000 sq ft">gal / 1000 ftÂ²</option>
                        <option value="lbs/acre">lbs / acre</option>
                        <option value="fl oz/acre">fl oz / acre</option>
                        <option value="gal/acre">gal / acre</option>
                    </select>
                </div>
            </div>
            <div class="form-row single" id="cp-density-row">
                <div class="form-group">
                    <label>Density (lbs/gallon)</label>
                    <input type="number" id="cp-density" step="0.1" placeholder="e.g. 10.5">
                    <div class="hint">For liquid products, used for nutrient calculations</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeCustomProductModal()">Cancel</button>
                <button class="submit-btn" onclick="saveCustomProduct()" style="margin-top:0">Save Product</button>
            </div>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div class="modal-overlay" id="product-detail-modal">
        <div class="modal" style="max-width:550px;">
            <h2 id="pd-title" style="margin-bottom:16px;">Product Details</h2>
            <div id="pd-body" style="max-height:60vh;overflow-y:auto;"></div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeProductDetailModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Efficacy Rating Modal -->
    <div class="modal-overlay" id="efficacy-modal">
        <div class="modal" style="max-width:400px;">
            <h2 style="margin-bottom:16px;">Rate Efficacy</h2>
            <div id="efficacy-stars" style="text-align:center;margin:16px 0;"></div>
            <div class="form-group">
                <label>Notes (optional)</label>
                <textarea id="efficacy-notes" placeholder="How effective was this application?" style="width:100%;min-height:60px;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeEfficacyModal()">Cancel</button>
                <button class="submit-btn" onclick="saveEfficacy()" style="margin-top:0">Save Rating</button>
            </div>
        </div>
    </div>

    <script src="/static/js/spray-tracker.js"></script>
</body>
</html>
