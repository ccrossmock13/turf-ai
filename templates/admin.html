<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a4d2e">
    <title>Admin Dashboard - Greenside AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #212529;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #1a4d2e 0%, #2d7a4a 100%);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-link {
            color: white;
            text-decoration: none;
            opacity: 0.8;
            font-size: 14px;
        }

        .back-link:hover { opacity: 1; }

        .logo {
            font-size: 22px;
            font-weight: 700;
        }

        .admin-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }

        .header-right {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            padding: 20px 24px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }

        .stat-card {
            text-align: center;
            padding: 12px;
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #1a4d2e;
        }

        .stat-number.warning { color: #dc3545; }
        .stat-number.success { color: #28a745; }
        .stat-number.info { color: #0d6efd; }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #1a4d2e;
            color: white;
            border-color: #1a4d2e;
        }

        .tab-btn:hover:not(.active) {
            border-color: #1a4d2e;
            color: #1a4d2e;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a4d2e;
        }

        /* Two Column Layout */
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 900px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }

        /* Feedback Cards */
        .feedback-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .feedback-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .feedback-rating {
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
        }

        .rating-positive { background: #d4edda; color: #155724; }
        .rating-negative { background: #f8d7da; color: #721c24; }
        .rating-unrated { background: #e9ecef; color: #6c757d; }

        .feedback-question {
            font-weight: 600;
            font-size: 15px;
            color: #1a4d2e;
            margin-bottom: 10px;
        }

        .feedback-answer {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 13px;
            line-height: 1.5;
            max-height: 120px;
            overflow-y: auto;
        }

        .feedback-correction {
            background: #fff3cd;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #ffc107;
            margin-bottom: 12px;
        }

        .correction-label {
            font-weight: 600;
            color: #856404;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .feedback-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary { background: #1a4d2e; color: white; }
        .btn-primary:hover { background: #143d24; }
        .btn-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .btn-danger:hover { background: #f1b0b7; }
        .btn-secondary { background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; }
        .btn-secondary:hover { background: #e9ecef; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }

        /* Analytics Charts */
        .chart-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .mini-chart {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 60px;
            margin-top: 12px;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, #1a4d2e, #2d7a4a);
            border-radius: 3px 3px 0 0;
            min-height: 4px;
            position: relative;
        }

        .chart-bar:hover {
            opacity: 0.8;
        }

        .chart-bar::after {
            content: attr(data-value);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #6c757d;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .chart-bar:hover::after {
            opacity: 1;
        }

        /* Topic Stats */
        .topic-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .topic-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .topic-name {
            width: 100px;
            font-size: 13px;
            color: #495057;
        }

        .topic-bar-container {
            flex: 1;
            background: #e9ecef;
            height: 20px;
            border-radius: 4px;
            overflow: hidden;
        }

        .topic-bar {
            height: 100%;
            background: linear-gradient(90deg, #1a4d2e, #2d7a4a);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 11px;
            color: white;
            font-weight: 600;
        }

        /* Cache Grid */
        .cache-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .cache-stat {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .cache-stat-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .cache-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #1a4d2e;
        }

        /* Recent Questions */
        .question-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .question-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
        }

        .question-time {
            color: #6c757d;
            font-size: 11px;
            white-space: nowrap;
        }

        .question-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .question-confidence {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .conf-high { background: #d4edda; color: #155724; }
        .conf-medium { background: #fff3cd; color: #856404; }
        .conf-low { background: #f8d7da; color: #721c24; }

        /* System Status */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .status-warning { background: #ffc107; }

        .status-label {
            font-size: 13px;
            color: #495057;
        }

        .status-value {
            margin-left: auto;
            font-size: 12px;
            color: #6c757d;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #6c757d;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 48px;
        }

        .spinner {
            border: 3px solid #e9ecef;
            border-top: 3px solid #1a4d2e;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Timestamp */
        .timestamp {
            font-size: 11px;
            color: #adb5bd;
        }

        /* Progress */
        .progress-bar {
            background: #e9ecef;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #1a4d2e, #2d7a4a);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 11px;
        }

        /* Alert */
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-success { background: #d4edda; color: #155724; }
        .alert-warning { background: #fff3cd; color: #856404; }
        .alert-info { background: #d1ecf1; color: #0c5460; }

        /* Facebook-Style Moderation */
        .mod-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .mod-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: white;
            border-radius: 8px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .mod-progress {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .mod-progress-text {
            font-weight: 600;
            color: #1a4d2e;
        }

        .mod-progress-bar {
            width: 200px;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }

        .mod-progress-fill {
            height: 100%;
            background: #1a4d2e;
            transition: width 0.3s;
        }

        .mod-stats {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #6c757d;
        }

        .mod-stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mod-stat-num {
            font-weight: 600;
            color: #212529;
        }

        .mod-shortcuts {
            font-size: 11px;
            color: #adb5bd;
        }

        .mod-shortcuts kbd {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            margin: 0 2px;
        }

        .mod-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .mod-card-header {
            padding: 16px 24px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mod-flag {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mod-flag-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .mod-flag-icon.user { background: #f8d7da; }
        .mod-flag-icon.auto { background: #fff3cd; }
        .mod-flag-icon.none { background: #e2e3e5; }

        .mod-flag-text {
            font-weight: 600;
            font-size: 14px;
        }

        .mod-confidence {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .mod-confidence.high { background: #d4edda; color: #155724; }
        .mod-confidence.medium { background: #fff3cd; color: #856404; }
        .mod-confidence.low { background: #f8d7da; color: #721c24; }

        .mod-card-body {
            padding: 24px;
        }

        .mod-section {
            margin-bottom: 20px;
        }

        .mod-section:last-child {
            margin-bottom: 0;
        }

        .mod-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .mod-question {
            font-size: 18px;
            font-weight: 600;
            color: #212529;
            line-height: 1.4;
        }

        .mod-answer {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.7;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .mod-user-note {
            background: #fff3cd;
            padding: 14px 16px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }

        .mod-user-note-label {
            font-weight: 600;
            color: #856404;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .mod-sources {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .mod-source {
            background: #e9ecef;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            color: #495057;
        }

        .mod-edit-area {
            width: 100%;
            min-height: 150px;
            padding: 14px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .mod-edit-area:focus {
            outline: none;
            border-color: #1a4d2e;
        }

        .mod-edit-area.active {
            border-color: #0d6efd;
            background: #f8f9ff;
        }

        .mod-card-footer {
            padding: 20px 24px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .mod-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .mod-btn {
            padding: 14px 32px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .mod-btn-approve {
            background: #28a745;
            color: white;
        }

        .mod-btn-approve:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .mod-btn-reject {
            background: #dc3545;
            color: white;
        }

        .mod-btn-reject:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .mod-btn-skip {
            background: #6c757d;
            color: white;
        }

        .mod-btn-skip:hover {
            background: #5a6268;
        }

        .mod-btn-edit {
            background: #0d6efd;
            color: white;
        }

        .mod-btn-edit:hover {
            background: #0b5ed7;
        }

        .mod-btn kbd {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 4px;
        }

        .mod-secondary-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
        }

        .mod-secondary-btn {
            background: none;
            border: none;
            color: #6c757d;
            font-size: 13px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .mod-secondary-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        .mod-reject-reasons {
            display: none;
            margin-top: 16px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .mod-reject-reasons.active {
            display: block;
        }

        .mod-reject-reason {
            display: block;
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .mod-reject-reason:hover {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .mod-reject-reason:last-child {
            margin-bottom: 0;
        }

        .mod-empty {
            text-align: center;
            padding: 80px 24px;
            background: white;
            border-radius: 12px;
        }

        .mod-empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .mod-empty-title {
            font-size: 24px;
            font-weight: 600;
            color: #28a745;
            margin-bottom: 8px;
        }

        .mod-empty-text {
            color: #6c757d;
            font-size: 15px;
        }

        .mod-filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .mod-filter-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mod-filter-btn.active {
            background: #1a4d2e;
            color: white;
            border-color: #1a4d2e;
        }

        .mod-filter-btn:hover:not(.active) {
            border-color: #1a4d2e;
        }

        /* Audit Log */
        .audit-item {
            display: flex;
            gap: 16px;
            padding: 14px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
            align-items: flex-start;
        }

        .audit-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .audit-icon.approve { background: #d4edda; }
        .audit-icon.reject { background: #f8d7da; }
        .audit-icon.correct { background: #d1ecf1; }

        .audit-content {
            flex: 1;
            min-width: 0;
        }

        .audit-action {
            font-weight: 600;
            color: #212529;
            margin-bottom: 4px;
        }

        .audit-question {
            font-size: 13px;
            color: #495057;
            margin-bottom: 4px;
        }

        .audit-meta {
            font-size: 11px;
            color: #6c757d;
        }

        .audit-reason {
            font-size: 12px;
            color: #6c757d;
            font-style: italic;
            margin-top: 4px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .header-right {
                display: none;
            }
        }

        /* Bulk Mode Styles */
        .bulk-actions-bar {
            background: #e9ecef;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .bulk-select-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }

        .bulk-select-btn {
            background: white;
            border: 1px solid #dee2e6;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .bulk-select-btn:hover {
            background: #f8f9fa;
        }

        .bulk-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .bulk-list-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .bulk-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            gap: 16px;
            align-items: flex-start;
            transition: all 0.2s;
        }

        .bulk-item:hover {
            border-color: #1a4d2e;
        }

        .bulk-item.selected {
            background: #e8f5e9;
            border-color: #28a745;
        }

        .bulk-item-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-top: 2px;
        }

        .bulk-item-content {
            flex: 1;
            min-width: 0;
        }

        .bulk-item-question {
            font-weight: 600;
            color: #212529;
            margin-bottom: 8px;
        }

        .bulk-item-answer {
            font-size: 13px;
            color: #6c757d;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bulk-item-meta {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            font-size: 12px;
        }

        .bulk-item-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .bulk-item-badge.priority {
            background: #fff3cd;
            color: #856404;
        }

        .bulk-item-badge.trending {
            background: #f8d7da;
            color: #721c24;
        }

        .bulk-item-badge.confidence {
            background: #e9ecef;
            color: #495057;
        }

        /* Trending Alert */
        .trending-alert {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .trending-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .trending-icon {
            font-size: 18px;
        }

        .trending-close {
            margin-left: auto;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #856404;
        }

        .trending-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .trending-item {
            background: white;
            padding: 10px 14px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .trending-item-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .trending-item-stats {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: #6c757d;
        }

        .trending-item-severity {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .trending-item-severity.high {
            background: #f8d7da;
            color: #721c24;
        }

        .trending-item-severity.medium {
            background: #fff3cd;
            color: #856404;
        }

        /* Enhanced Mobile Styles */
        @media (max-width: 640px) {
            header {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 8px;
            }

            .header-left {
                gap: 10px;
            }

            .back-link {
                font-size: 13px;
            }

            .logo {
                font-size: 18px;
            }

            .admin-badge {
                font-size: 10px;
                padding: 3px 8px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                padding: 12px 16px;
                gap: 8px;
            }

            .stat-card {
                padding: 8px;
            }

            .stat-number {
                font-size: 22px;
            }

            .stat-label {
                font-size: 11px;
            }

            .container {
                padding: 12px;
            }

            .tabs {
                gap: 6px;
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 8px;
            }

            .tab-btn {
                padding: 8px 14px;
                font-size: 13px;
                white-space: nowrap;
                flex-shrink: 0;
            }

            .card {
                padding: 12px;
                border-radius: 8px;
            }

            .card-title {
                font-size: 14px;
            }

            .feedback-card {
                padding: 14px;
            }

            .feedback-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .feedback-meta {
                font-size: 11px;
            }

            .feedback-question,
            .feedback-answer {
                font-size: 13px;
            }

            .feedback-actions {
                flex-wrap: wrap;
                gap: 6px;
            }

            .action-btn {
                padding: 8px 14px;
                font-size: 12px;
            }

            .bulk-actions-bar {
                flex-direction: column;
                padding: 10px;
            }

            .bulk-actions {
                width: 100%;
                justify-content: center;
            }

            .filter-bar {
                flex-direction: column;
                gap: 8px;
            }

            .filter-bar select,
            .filter-bar input {
                width: 100%;
            }

            .training-card {
                padding: 12px;
            }

            .example-text {
                font-size: 12px;
            }

            /* Touch-friendly buttons */
            button, .action-btn, .tab-btn {
                min-height: 44px;
            }

            /* Better checkbox touch targets */
            .bulk-checkbox {
                width: 24px;
                height: 24px;
            }

            /* Trending panel mobile */
            .trending-panel {
                padding: 10px;
            }

            .trending-item {
                flex-direction: column;
                gap: 4px;
                align-items: flex-start;
            }
        }

        /* Very small screens */
        @media (max-width: 380px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .stat-number {
                font-size: 18px;
            }

            .logo {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <a href="/" class="back-link">‚Üê Back</a>
            <div class="logo">Greenside AI</div>
            <div class="admin-badge">Admin</div>
        </div>
        <div class="header-right">
            <button class="header-btn" onclick="loadAllData()">‚Üª Refresh</button>
        </div>
    </header>

    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="stat-number" id="statQueries">-</div>
            <div class="stat-label">Total Queries</div>
        </div>
        <div class="stat-card">
            <div class="stat-number info" id="statToday">-</div>
            <div class="stat-label">Today</div>
        </div>
        <div class="stat-card">
            <div class="stat-number success" id="statPositive">-</div>
            <div class="stat-label">üëç Positive</div>
        </div>
        <div class="stat-card">
            <div class="stat-number warning" id="statNegative">-</div>
            <div class="stat-label">üëé Negative</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="statPending">-</div>
            <div class="stat-label">Needs Review</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="statAvgConf">-</div>
            <div class="stat-label">Avg Confidence</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="statCacheRate">-</div>
            <div class="stat-label">Cache Hit Rate</div>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
            <button class="tab-btn" onclick="switchTab('review')">Moderation Queue</button>
            <button class="tab-btn" onclick="switchTab('audit')">Audit Log</button>
            <button class="tab-btn" onclick="switchTab('analytics')">Analytics</button>
            <button class="tab-btn" onclick="switchTab('system')">System</button>
        </div>

        <!-- Overview Tab -->
        <div class="tab-content active" id="overviewTab">
            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Recent Questions</div>
                    </div>
                    <div class="question-list" id="recentQuestions">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">System Status</div>
                    </div>
                    <div class="status-grid" id="systemStatus">
                        <div class="status-item">
                            <div class="status-indicator status-online"></div>
                            <div class="status-label">OpenAI API</div>
                            <div class="status-value">Connected</div>
                        </div>
                        <div class="status-item">
                            <div class="status-indicator status-online"></div>
                            <div class="status-label">Pinecone</div>
                            <div class="status-value">Connected</div>
                        </div>
                        <div class="status-item">
                            <div class="status-indicator" id="weatherStatus"></div>
                            <div class="status-label">Weather API</div>
                            <div class="status-value" id="weatherStatusText">-</div>
                        </div>
                        <div class="status-item">
                            <div class="status-indicator" id="tavilyStatus"></div>
                            <div class="status-label">Web Search</div>
                            <div class="status-value" id="tavilyStatusText">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Top Topics</div>
                    </div>
                    <div class="topic-list" id="topTopics">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Quick Actions</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn btn-primary" onclick="switchTab('review')">
                            Review Pending Feedback
                        </button>
                        <button class="btn btn-secondary" onclick="testAPIs()">
                            Test API Connections
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Export Data</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <a href="/admin/export/feedback" class="btn btn-secondary" download>
                            üì• Export All Feedback (CSV)
                        </a>
                        <a href="/admin/export/training" class="btn btn-secondary" download>
                            üì• Export Training Data (CSV)
                        </a>
                        <a href="/admin/export/moderation" class="btn btn-secondary" download>
                            üì• Export Moderation Log (CSV)
                        </a>
                        <button class="btn btn-secondary" onclick="exportAnalyticsJson()">
                            üìä Export Analytics (JSON)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review/Moderation Tab -->
        <div class="tab-content" id="reviewTab">
            <div class="mod-container">
                <!-- Trending Issues Alert -->
                <div id="trendingAlert" class="trending-alert" style="display: none;">
                    <div class="trending-header">
                        <span class="trending-icon">üî•</span>
                        <strong>Trending Issues</strong>
                        <button class="trending-close" onclick="hideTrendingAlert()">√ó</button>
                    </div>
                    <div id="trendingList" class="trending-list"></div>
                </div>

                <!-- Filter Bar with Mode Toggle -->
                <div class="mod-filter-bar">
                    <button class="mod-filter-btn active" data-filter="all" onclick="setModFilter('all')">All</button>
                    <button class="mod-filter-btn" data-filter="negative" onclick="setModFilter('negative')">User Flagged</button>
                    <button class="mod-filter-btn" data-filter="low_confidence" onclick="setModFilter('low_confidence')">Low Confidence</button>
                    <button class="mod-filter-btn" data-filter="priority" onclick="setModFilter('priority')">üî• Priority</button>
                    <div style="flex: 1;"></div>
                    <button class="mod-filter-btn" id="bulkModeBtn" onclick="toggleBulkMode()">‚òê Bulk Mode</button>
                </div>

                <!-- Bulk Actions Bar (hidden by default) -->
                <div id="bulkActionsBar" class="bulk-actions-bar" style="display: none;">
                    <div class="bulk-select-info">
                        <span id="bulkSelectedCount">0</span> selected
                        <button class="bulk-select-btn" onclick="selectAllVisible()">Select All</button>
                        <button class="bulk-select-btn" onclick="clearSelection()">Clear</button>
                    </div>
                    <div class="bulk-actions">
                        <button class="btn btn-success" onclick="bulkApprove()">‚úì Approve Selected</button>
                        <button class="btn btn-danger" onclick="bulkReject()">‚úó Reject Selected</button>
                        <button class="btn btn-primary" onclick="bulkApproveHighConfidence()">‚ö° Auto-Approve High Confidence</button>
                    </div>
                </div>

                <!-- Progress Header -->
                <div class="mod-header">
                    <div class="mod-progress">
                        <div class="mod-progress-text" id="modProgressText">Loading...</div>
                        <div class="mod-progress-bar">
                            <div class="mod-progress-fill" id="modProgressFill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="mod-stats">
                        <div class="mod-stat">
                            <span class="mod-stat-num" id="modApproved">0</span> approved
                        </div>
                        <div class="mod-stat">
                            <span class="mod-stat-num" id="modRejected">0</span> rejected
                        </div>
                        <div class="mod-stat">
                            <span class="mod-stat-num" id="modSkipped">0</span> skipped
                        </div>
                    </div>
                </div>

                <!-- Keyboard Shortcuts Hint -->
                <div class="mod-shortcuts" style="text-align: center; margin-bottom: 16px;">
                    <kbd>A</kbd> Approve &nbsp; <kbd>R</kbd> Reject &nbsp; <kbd>E</kbd> Edit Mode &nbsp; <kbd>S</kbd> Skip &nbsp; <kbd>‚Üê</kbd><kbd>‚Üí</kbd> Navigate &nbsp; <kbd>B</kbd> Bulk Mode
                </div>

                <!-- Loading State -->
                <div class="loading" id="modLoading">
                    <div class="spinner"></div>
                    <p>Loading queue...</p>
                </div>

                <!-- Main Moderation Card (single item mode) -->
                <div id="modCardContainer" style="display: none;"></div>

                <!-- Bulk Mode List -->
                <div id="bulkListContainer" class="bulk-list-container" style="display: none;"></div>

                <!-- Empty State -->
                <div class="mod-empty" id="modEmpty" style="display: none;">
                    <div class="mod-empty-icon">‚úì</div>
                    <div class="mod-empty-title">Queue Clear!</div>
                    <div class="mod-empty-text">No items need review. Great work!</div>
                </div>
            </div>
        </div>

        <!-- Audit Log Tab -->
        <div class="tab-content" id="auditTab">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Moderator Activity Log</div>
                    <button class="btn btn-secondary" onclick="loadAuditLog()">Refresh</button>
                </div>
                <div class="loading" id="auditLoading">
                    <div class="spinner"></div>
                </div>
                <div id="auditList"></div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-content" id="analyticsTab">
            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Queries This Week</div>
                    </div>
                    <div class="mini-chart" id="weeklyChart"></div>
                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: #6c757d;">
                        <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Confidence Distribution</div>
                    </div>
                    <div class="topic-list" id="confidenceDistribution">
                        <div class="topic-item">
                            <div class="topic-name">High (80%+)</div>
                            <div class="topic-bar-container">
                                <div class="topic-bar" id="confHigh" style="width: 0%">0%</div>
                            </div>
                        </div>
                        <div class="topic-item">
                            <div class="topic-name">Medium</div>
                            <div class="topic-bar-container">
                                <div class="topic-bar" id="confMed" style="width: 0%; background: linear-gradient(90deg, #ffc107, #ffca2c);">0%</div>
                            </div>
                        </div>
                        <div class="topic-item">
                            <div class="topic-name">Low (<60%)</div>
                            <div class="topic-bar-container">
                                <div class="topic-bar" id="confLow" style="width: 0%; background: linear-gradient(90deg, #dc3545, #e4606d);">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">All Feedback History</div>
                    <button class="btn btn-secondary" onclick="loadAllFeedback()">Refresh</button>
                </div>
                <div class="loading" id="allLoading">
                    <div class="spinner"></div>
                </div>
                <div class="feedback-list" id="allList"></div>
            </div>
        </div>

        <!-- System Tab -->
        <div class="tab-content" id="systemTab">
            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Embedding Cache</div>
                        <button class="btn btn-secondary" onclick="loadCacheStats()">Refresh</button>
                    </div>
                    <div class="cache-grid">
                        <div class="cache-stat">
                            <div class="cache-stat-label">Size</div>
                            <div class="cache-stat-value" id="embCacheSize">-</div>
                        </div>
                        <div class="cache-stat">
                            <div class="cache-stat-label">Hits</div>
                            <div class="cache-stat-value" id="embCacheHits">-</div>
                        </div>
                        <div class="cache-stat">
                            <div class="cache-stat-label">Misses</div>
                            <div class="cache-stat-value" id="embCacheMisses">-</div>
                        </div>
                        <div class="cache-stat">
                            <div class="cache-stat-label">Hit Rate</div>
                            <div class="cache-stat-value" id="embCacheRate">-</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Source URL Cache</div>
                    </div>
                    <div class="cache-grid">
                        <div class="cache-stat">
                            <div class="cache-stat-label">Size</div>
                            <div class="cache-stat-value" id="urlCacheSize">-</div>
                        </div>
                        <div class="cache-stat">
                            <div class="cache-stat-label">Hits</div>
                            <div class="cache-stat-value" id="urlCacheHits">-</div>
                        </div>
                        <div class="cache-stat">
                            <div class="cache-stat-label">Misses</div>
                            <div class="cache-stat-value" id="urlCacheMisses">-</div>
                        </div>
                        <div class="cache-stat">
                            <div class="cache-stat-label">Hit Rate</div>
                            <div class="cache-stat-value" id="urlCacheRate">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Training Data</div>
                </div>
                <p style="color: #6c757d; margin-bottom: 16px; font-size: 14px;">
                    Approved corrections can be used to fine-tune the model.
                </p>
                <div style="margin-bottom: 16px;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="trainingProgress" style="width: 0%">0%</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 13px; color: #6c757d;" id="trainingText"></div>
                </div>
                <button class="btn btn-primary" onclick="generateTrainingFile()">
                    Generate Training File
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Knowledge Base</div>
                    <button class="btn btn-secondary" onclick="loadKnowledgeStatus()">Refresh</button>
                </div>
                <div class="cache-grid" style="margin-bottom: 16px;">
                    <div class="cache-stat">
                        <div class="cache-stat-label">Indexed Files</div>
                        <div class="cache-stat-value" id="kbIndexed">-</div>
                    </div>
                    <div class="cache-stat">
                        <div class="cache-stat-label">Total Chunks</div>
                        <div class="cache-stat-value" id="kbChunks">-</div>
                    </div>
                    <div class="cache-stat">
                        <div class="cache-stat-label">Total PDFs</div>
                        <div class="cache-stat-value" id="kbTotal">-</div>
                    </div>
                    <div class="cache-stat">
                        <div class="cache-stat-label">Unindexed</div>
                        <div class="cache-stat-value" id="kbUnindexed" style="color: #dc3545;">-</div>
                    </div>
                </div>
                <div id="kbUnindexedList" style="margin-bottom: 16px; font-size: 13px; color: #6c757d;"></div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="buildKnowledge(10)">
                        Index 10 Files
                    </button>
                    <button class="btn btn-secondary" onclick="buildKnowledge(50)">
                        Index 50 Files
                    </button>
                </div>
                <div id="kbBuildStatus" style="margin-top: 12px; font-size: 13px;"></div>
            </div>

            <!-- Fine-tuning Section -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üîÑ Feedback Loop</div>
                    <button class="btn btn-secondary" onclick="loadFineTuningStatus()">Refresh</button>
                </div>

                <!-- Training Data Status -->
                <div class="cache-grid" style="margin-bottom: 16px;">
                    <div class="cache-stat">
                        <div class="cache-stat-label">Training Examples</div>
                        <div class="cache-stat-value" id="ftExamples">-</div>
                    </div>
                    <div class="cache-stat">
                        <div class="cache-stat-label">Needed</div>
                        <div class="cache-stat-value" id="ftNeeded">50</div>
                    </div>
                    <div class="cache-stat">
                        <div class="cache-stat-label">Ready to Train</div>
                        <div class="cache-stat-value" id="ftReady">-</div>
                    </div>
                    <div class="cache-stat">
                        <div class="cache-stat-label">Active Model</div>
                        <div class="cache-stat-value" id="ftModel" style="font-size: 11px;">-</div>
                    </div>
                </div>

                <!-- Fine-tuning Actions -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px;">
                    <button class="btn btn-primary" id="startFineTuningBtn" onclick="startFineTuning()" disabled>
                        üöÄ Start Fine-tuning
                    </button>
                    <button class="btn btn-secondary" onclick="runEvaluation()">
                        üìä Run Evaluation
                    </button>
                </div>

                <div id="ftStatus" style="font-size: 13px; margin-bottom: 12px;"></div>

                <!-- Recent Jobs -->
                <div id="ftJobs" style="font-size: 13px;"></div>
            </div>

            <!-- Source Quality Section -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìà Source Quality</div>
                    <button class="btn btn-secondary" onclick="loadSourceQuality()">Refresh</button>
                </div>
                <div id="sourceQualityContent">
                    <p style="color: #6c757d; font-size: 13px;">Source quality is tracked based on user feedback. Sources that consistently lead to good answers get boosted in search results.</p>
                </div>
                <div id="lowQualitySources" style="margin-top: 12px;"></div>
            </div>

            <!-- Evaluation History -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìä Evaluation History</div>
                </div>
                <div id="evalHistory">
                    <p style="color: #6c757d; font-size: 13px;">Run evaluations to track model quality over time.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'overview';

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        async function loadAllData() {
            await Promise.all([
                loadStats(),
                loadCacheStats(),
                loadRecentQuestions(),
                checkAPIStatus()
            ]);
        }

        async function loadStats() {
            try {
                const [statsRes, cacheRes] = await Promise.all([
                    fetch('/admin/stats'),
                    fetch('/admin/cache')
                ]);

                const stats = await statsRes.json();
                const cache = await cacheRes.json();

                // Update stat cards
                document.getElementById('statQueries').textContent = stats.total_feedback || 0;
                document.getElementById('statToday').textContent = stats.today_count || '-';
                document.getElementById('statPositive').textContent = stats.positive_feedback || 0;
                document.getElementById('statNegative').textContent = stats.negative_feedback || 0;

                const pending = stats.unreviewed_negative || 0;
                const pendingEl = document.getElementById('statPending');
                pendingEl.textContent = pending;
                pendingEl.className = 'stat-number' + (pending > 0 ? ' warning' : '');

                document.getElementById('statAvgConf').textContent = stats.avg_confidence
                    ? Math.round(stats.avg_confidence) + '%'
                    : '-';

                // Cache hit rate
                const embCache = cache.embedding_cache || {};
                const total = (embCache.hits || 0) + (embCache.misses || 0);
                const hitRate = total > 0 ? Math.round((embCache.hits / total) * 100) : 0;
                document.getElementById('statCacheRate').textContent = hitRate + '%';

                // Training progress
                const ready = stats.approved_for_training || 0;
                const needed = 50;
                const percentage = Math.min((ready / needed) * 100, 100);
                document.getElementById('trainingProgress').style.width = percentage + '%';
                document.getElementById('trainingProgress').textContent = Math.round(percentage) + '%';
                document.getElementById('trainingText').textContent =
                    ready >= needed
                        ? `Ready to train! ${ready} examples`
                        : `${ready}/${needed} examples needed`;

                // Update topic stats
                updateTopicStats(stats.topic_counts || {});

                // Update confidence distribution
                updateConfidenceDistribution(stats.confidence_distribution || {});

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function updateTopicStats(topics) {
            const container = document.getElementById('topTopics');
            const sorted = Object.entries(topics).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const max = sorted.length > 0 ? sorted[0][1] : 1;

            if (sorted.length === 0) {
                container.innerHTML = '<div class="empty-state">No data yet</div>';
                return;
            }

            container.innerHTML = sorted.map(([topic, count]) => {
                const width = Math.round((count / max) * 100);
                return `
                    <div class="topic-item">
                        <div class="topic-name">${escapeHtml(topic)}</div>
                        <div class="topic-bar-container">
                            <div class="topic-bar" style="width: ${width}%">${count}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateConfidenceDistribution(dist) {
            const total = (dist.high || 0) + (dist.medium || 0) + (dist.low || 0);
            if (total === 0) return;

            const highPct = Math.round((dist.high || 0) / total * 100);
            const medPct = Math.round((dist.medium || 0) / total * 100);
            const lowPct = Math.round((dist.low || 0) / total * 100);

            document.getElementById('confHigh').style.width = highPct + '%';
            document.getElementById('confHigh').textContent = highPct + '%';
            document.getElementById('confMed').style.width = medPct + '%';
            document.getElementById('confMed').textContent = medPct + '%';
            document.getElementById('confLow').style.width = lowPct + '%';
            document.getElementById('confLow').textContent = lowPct + '%';
        }

        async function loadRecentQuestions() {
            try {
                const response = await fetch('/admin/feedback/all');
                const feedback = await response.json();
                const container = document.getElementById('recentQuestions');

                const recent = feedback.slice(0, 8);
                if (recent.length === 0) {
                    container.innerHTML = '<div class="empty-state">No questions yet</div>';
                    return;
                }

                container.innerHTML = recent.map(item => {
                    const time = item.timestamp
                        ? new Date(item.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                        : '';
                    const confClass = item.confidence >= 80 ? 'conf-high' : item.confidence >= 60 ? 'conf-medium' : 'conf-low';

                    return `
                        <div class="question-item">
                            <div class="question-time">${time}</div>
                            <div class="question-text">${escapeHtml(item.question)}</div>
                            ${item.rating === 'positive' ? '<span class="conf-high question-confidence">üëç</span>' : item.rating === 'negative' ? '<span class="conf-low question-confidence">üëé</span>' : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading recent questions:', error);
            }
        }

        async function checkAPIStatus() {
            // Weather API
            const weatherStatus = document.getElementById('weatherStatus');
            const weatherText = document.getElementById('weatherStatusText');
            try {
                const res = await fetch('/api/weather?city=Louisville&state=KY');
                if (res.ok) {
                    weatherStatus.className = 'status-indicator status-online';
                    weatherText.textContent = 'Connected';
                } else {
                    weatherStatus.className = 'status-indicator status-warning';
                    weatherText.textContent = 'No API Key';
                }
            } catch {
                weatherStatus.className = 'status-indicator status-offline';
                weatherText.textContent = 'Error';
            }

            // Tavily status (no direct way to test, assume based on env)
            const tavilyStatus = document.getElementById('tavilyStatus');
            const tavilyText = document.getElementById('tavilyStatusText');
            tavilyStatus.className = 'status-indicator status-online';
            tavilyText.textContent = 'Configured';
        }

        async function loadCacheStats() {
            try {
                const response = await fetch('/admin/cache');
                const cache = await response.json();

                const emb = cache.embedding_cache || {};
                document.getElementById('embCacheSize').textContent = emb.size || 0;
                document.getElementById('embCacheHits').textContent = emb.hits || 0;
                document.getElementById('embCacheMisses').textContent = emb.misses || 0;
                document.getElementById('embCacheRate').textContent = emb.hit_rate || '0%';

                const url = cache.source_url_cache || {};
                document.getElementById('urlCacheSize').textContent = url.size || 0;
                document.getElementById('urlCacheHits').textContent = url.hits || 0;
                document.getElementById('urlCacheMisses').textContent = url.misses || 0;
                document.getElementById('urlCacheRate').textContent = url.hit_rate || '0%';
            } catch (error) {
                console.error('Error loading cache stats:', error);
            }
        }

        // Facebook-style moderation state
        let modQueue = [];
        let modIndex = 0;
        let modFilter = 'all';
        let modSessionStats = { approved: 0, rejected: 0, skipped: 0 };
        let modEditMode = false;
        let modSkippedItems = [];

        // Bulk mode state
        let bulkMode = false;
        let selectedItems = new Set();

        const REJECT_REASONS = [
            { id: 'inaccurate', text: 'Inaccurate information', desc: 'Contains factual errors' },
            { id: 'outdated', text: 'Outdated information', desc: 'Recommendations are no longer current' },
            { id: 'incomplete', text: 'Incomplete answer', desc: 'Missing important details' },
            { id: 'off_topic', text: 'Off-topic response', desc: 'Doesn\'t address the question' },
            { id: 'harmful', text: 'Potentially harmful advice', desc: 'Could damage turf or environment' },
            { id: 'other', text: 'Other issue', desc: 'Different problem' }
        ];

        function setModFilter(filter) {
            modFilter = filter;
            document.querySelectorAll('.mod-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            loadReviewQueue();
        }

        async function loadReviewQueue() {
            document.getElementById('modLoading').style.display = 'block';
            document.getElementById('modCardContainer').style.display = 'none';
            document.getElementById('bulkListContainer').style.display = 'none';
            document.getElementById('modEmpty').style.display = 'none';

            try {
                // Use priority queue endpoint for priority filter
                const endpoint = modFilter === 'priority'
                    ? '/admin/priority-queue'
                    : `/admin/review-queue?type=${modFilter}`;

                const response = await fetch(endpoint);
                modQueue = await response.json();
                modIndex = 0;
                modSkippedItems = [];
                selectedItems.clear();
                updateBulkSelectedCount();

                document.getElementById('modLoading').style.display = 'none';

                if (modQueue.length === 0) {
                    document.getElementById('modEmpty').style.display = 'block';
                    updateModProgress();
                } else if (bulkMode) {
                    document.getElementById('bulkListContainer').style.display = 'block';
                    renderBulkList();
                } else {
                    document.getElementById('modCardContainer').style.display = 'block';
                    renderCurrentItem();
                }

                // Load trending issues on first load
                loadTrendingIssues();
            } catch (error) {
                console.error('Error loading review queue:', error);
                document.getElementById('modLoading').style.display = 'none';
                document.getElementById('modEmpty').style.display = 'block';
                document.querySelector('.mod-empty-title').textContent = 'Error';
                document.querySelector('.mod-empty-text').textContent = 'Failed to load queue';
            }
        }

        // =====================================================================
        // BULK MODE FUNCTIONS
        // =====================================================================

        function toggleBulkMode() {
            bulkMode = !bulkMode;
            const btn = document.getElementById('bulkModeBtn');
            btn.textContent = bulkMode ? '‚òë Bulk Mode' : '‚òê Bulk Mode';
            btn.classList.toggle('active', bulkMode);

            document.getElementById('bulkActionsBar').style.display = bulkMode ? 'flex' : 'none';

            if (bulkMode) {
                document.getElementById('modCardContainer').style.display = 'none';
                document.getElementById('bulkListContainer').style.display = 'block';
                renderBulkList();
            } else {
                document.getElementById('bulkListContainer').style.display = 'none';
                if (modQueue.length > 0) {
                    document.getElementById('modCardContainer').style.display = 'block';
                    renderCurrentItem();
                }
                selectedItems.clear();
                updateBulkSelectedCount();
            }
        }

        function renderBulkList() {
            const container = document.getElementById('bulkListContainer');

            container.innerHTML = modQueue.map(item => {
                const isSelected = selectedItems.has(item.id);
                const confClass = item.confidence >= 80 ? 'conf-high' : item.confidence >= 60 ? 'conf-medium' : 'conf-low';

                return `
                    <div class="bulk-item ${isSelected ? 'selected' : ''}" onclick="toggleItemSelection(${item.id})">
                        <input type="checkbox" class="bulk-item-checkbox"
                            ${isSelected ? 'checked' : ''}
                            onclick="event.stopPropagation(); toggleItemSelection(${item.id})">
                        <div class="bulk-item-content">
                            <div class="bulk-item-question">${escapeHtml(item.question)}</div>
                            <div class="bulk-item-answer">${escapeHtml(item.ai_answer?.substring(0, 200) || '')}...</div>
                            <div class="bulk-item-meta">
                                <span class="bulk-item-badge confidence ${confClass}">${item.confidence ? Math.round(item.confidence) + '%' : 'N/A'}</span>
                                ${item.review_type === 'user_flagged' ? '<span class="bulk-item-badge priority">üëé User Flagged</span>' : ''}
                                ${item.is_trending ? '<span class="bulk-item-badge trending">üî• Trending</span>' : ''}
                                ${item.frequency > 1 ? '<span class="bulk-item-badge">' + item.frequency + 'x asked</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateModProgress();
        }

        function toggleItemSelection(id) {
            if (selectedItems.has(id)) {
                selectedItems.delete(id);
            } else {
                selectedItems.add(id);
            }
            updateBulkSelectedCount();

            // Update visual state
            const items = document.querySelectorAll('.bulk-item');
            items.forEach(item => {
                const checkbox = item.querySelector('.bulk-item-checkbox');
                const itemId = parseInt(checkbox.onclick.toString().match(/toggleItemSelection\((\d+)\)/)?.[1]);
                if (itemId === id) {
                    item.classList.toggle('selected', selectedItems.has(id));
                    checkbox.checked = selectedItems.has(id);
                }
            });
        }

        function selectAllVisible() {
            modQueue.forEach(item => selectedItems.add(item.id));
            updateBulkSelectedCount();
            renderBulkList();
        }

        function clearSelection() {
            selectedItems.clear();
            updateBulkSelectedCount();
            renderBulkList();
        }

        function updateBulkSelectedCount() {
            document.getElementById('bulkSelectedCount').textContent = selectedItems.size;
        }

        async function bulkApprove() {
            if (selectedItems.size === 0) {
                alert('No items selected');
                return;
            }

            if (!confirm(`Approve ${selectedItems.size} items?`)) return;

            try {
                const response = await fetch('/admin/bulk-moderate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ids: Array.from(selectedItems),
                        action: 'approve'
                    })
                });

                const result = await response.json();
                alert(`Approved: ${result.success}, Failed: ${result.failed}`);

                modSessionStats.approved += result.success;
                selectedItems.clear();
                loadReviewQueue();
                loadStats();
            } catch (error) {
                console.error('Bulk approve error:', error);
                alert('Error processing bulk approve');
            }
        }

        async function bulkReject() {
            if (selectedItems.size === 0) {
                alert('No items selected');
                return;
            }

            const reason = prompt('Rejection reason (optional):');
            if (!confirm(`Reject ${selectedItems.size} items?`)) return;

            try {
                const response = await fetch('/admin/bulk-moderate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ids: Array.from(selectedItems),
                        action: 'reject',
                        reason: reason
                    })
                });

                const result = await response.json();
                alert(`Rejected: ${result.success}, Failed: ${result.failed}`);

                modSessionStats.rejected += result.success;
                selectedItems.clear();
                loadReviewQueue();
                loadStats();
            } catch (error) {
                console.error('Bulk reject error:', error);
                alert('Error processing bulk reject');
            }
        }

        async function bulkApproveHighConfidence() {
            const minConf = prompt('Minimum confidence % to auto-approve:', '80');
            if (!minConf) return;

            if (!confirm(`Auto-approve all items with confidence >= ${minConf}%?`)) return;

            try {
                const response = await fetch('/admin/bulk-approve-high-confidence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        min_confidence: parseInt(minConf),
                        limit: 100
                    })
                });

                const result = await response.json();
                alert(`Auto-approved: ${result.success} items\n${result.message || ''}`);

                modSessionStats.approved += result.success;
                loadReviewQueue();
                loadStats();
            } catch (error) {
                console.error('Auto-approve error:', error);
                alert('Error processing auto-approve');
            }
        }

        // =====================================================================
        // TRENDING ISSUES
        // =====================================================================

        async function loadTrendingIssues() {
            try {
                const response = await fetch('/admin/trending-issues?min_frequency=2&days=7');
                const trending = await response.json();

                const container = document.getElementById('trendingList');
                const alert = document.getElementById('trendingAlert');

                if (trending.length === 0) {
                    alert.style.display = 'none';
                    return;
                }

                container.innerHTML = trending.slice(0, 5).map(item => `
                    <div class="trending-item">
                        <div class="trending-item-text">${escapeHtml(item.question)}</div>
                        <div class="trending-item-stats">
                            <span>${item.frequency}x asked</span>
                            <span>${item.avg_confidence ? item.avg_confidence + '% conf' : 'N/A'}</span>
                            ${item.negative_count > 0 ? '<span>üëé ' + item.negative_count + '</span>' : ''}
                            <span class="trending-item-severity ${item.severity}">${item.severity}</span>
                        </div>
                    </div>
                `).join('');

                alert.style.display = 'block';
            } catch (error) {
                console.error('Error loading trending issues:', error);
            }
        }

        function hideTrendingAlert() {
            document.getElementById('trendingAlert').style.display = 'none';
        }

        // =====================================================================
        // EXPORT FUNCTIONS
        // =====================================================================

        async function exportAnalyticsJson() {
            try {
                const response = await fetch('/admin/export/analytics');
                const data = await response.json();

                // Download as JSON file
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'analytics_export.json';
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting analytics');
            }
        }

        function updateModProgress() {
            const total = modQueue.length + modSessionStats.approved + modSessionStats.rejected;
            const reviewed = modSessionStats.approved + modSessionStats.rejected;
            const remaining = modQueue.length;

            document.getElementById('modProgressText').textContent = remaining > 0
                ? `${modIndex + 1} of ${remaining} remaining`
                : 'Queue complete';

            const pct = total > 0 ? (reviewed / total) * 100 : 100;
            document.getElementById('modProgressFill').style.width = pct + '%';

            document.getElementById('modApproved').textContent = modSessionStats.approved;
            document.getElementById('modRejected').textContent = modSessionStats.rejected;
            document.getElementById('modSkipped').textContent = modSessionStats.skipped;
        }

        function renderCurrentItem() {
            if (modIndex >= modQueue.length) {
                // Check if we have skipped items to review
                if (modSkippedItems.length > 0) {
                    modQueue = modSkippedItems;
                    modSkippedItems = [];
                    modIndex = 0;
                    renderCurrentItem();
                    return;
                }
                document.getElementById('modCardContainer').style.display = 'none';
                document.getElementById('modEmpty').style.display = 'block';
                updateModProgress();
                return;
            }

            const item = modQueue[modIndex];
            const reviewType = item.review_type;

            // Determine flag display based on review type
            let flagIcon, flagText, flagClass;
            if (reviewType === 'user_flagged') {
                flagIcon = 'üëé';
                flagText = 'User Flagged (Negative)';
                flagClass = 'user';
            } else if (reviewType === 'no_feedback') {
                flagIcon = '‚ùì';
                flagText = 'No Feedback Provided';
                flagClass = 'none';
            } else {
                flagIcon = '‚ö†Ô∏è';
                flagText = 'Auto-Flagged (Low Confidence)';
                flagClass = 'auto';
            }

            const confClass = item.confidence >= 80 ? 'high' : item.confidence >= 60 ? 'medium' : 'low';
            const confText = item.confidence !== null ? Math.round(item.confidence) + '% confidence' : 'No score';

            const sourcesHtml = (item.sources || []).slice(0, 5).map(s => {
                const name = s.name || s.title || 'Source';
                return `<span class="mod-source">${escapeHtml(name)}</span>`;
            }).join('');

            const userNoteHtml = item.user_correction ? `
                <div class="mod-section">
                    <div class="mod-user-note">
                        <div class="mod-user-note-label">User Correction Suggested:</div>
                        <div>${escapeHtml(item.user_correction)}</div>
                    </div>
                </div>
            ` : '';

            const rejectReasonsHtml = REJECT_REASONS.map(r => `
                <button class="mod-reject-reason" onclick="submitReject('${r.id}', '${escapeHtml(r.text)}')">
                    <strong>${r.text}</strong><br>
                    <span style="color: #6c757d; font-size: 12px;">${r.desc}</span>
                </button>
            `).join('');

            document.getElementById('modCardContainer').innerHTML = `
                <div class="mod-card">
                    <div class="mod-card-header">
                        <div class="mod-flag">
                            <div class="mod-flag-icon ${flagClass}">
                                ${flagIcon}
                            </div>
                            <div class="mod-flag-text">
                                ${flagText}
                            </div>
                        </div>
                        <div class="mod-confidence ${confClass}">${confText}</div>
                    </div>
                    <div class="mod-card-body">
                        <div class="mod-section">
                            <div class="mod-label">Question</div>
                            <div class="mod-question">${escapeHtml(item.question)}</div>
                        </div>
                        <div class="mod-section">
                            <div class="mod-label">AI Response</div>
                            <div class="mod-answer">${escapeHtml(item.ai_answer)}</div>
                        </div>
                        ${sourcesHtml ? `
                            <div class="mod-section">
                                <div class="mod-label">Sources Used</div>
                                <div class="mod-sources">${sourcesHtml}</div>
                            </div>
                        ` : ''}
                        ${userNoteHtml}
                        <div class="mod-section" id="modEditSection" style="display: none;">
                            <div class="mod-label">Edit Answer <span style="color: #6c757d; font-weight: normal;">(will be used for training)</span></div>
                            <textarea class="mod-edit-area" id="modEditArea" placeholder="Enter corrected answer...">${item.user_correction || item.ai_answer}</textarea>
                        </div>
                    </div>
                    <div class="mod-card-footer">
                        <div class="mod-actions" id="modMainActions">
                            <button class="mod-btn mod-btn-approve" onclick="submitApprove()">
                                ‚úì Approve <kbd>A</kbd>
                            </button>
                            <button class="mod-btn mod-btn-edit" onclick="toggleEditMode()">
                                ‚úé Edit <kbd>E</kbd>
                            </button>
                            <button class="mod-btn mod-btn-reject" onclick="showRejectReasons()">
                                ‚úó Reject <kbd>R</kbd>
                            </button>
                        </div>
                        <div class="mod-actions" id="modEditActions" style="display: none;">
                            <button class="mod-btn mod-btn-approve" onclick="submitApproveWithEdit()">
                                ‚úì Save & Approve
                            </button>
                            <button class="mod-btn mod-btn-skip" onclick="toggleEditMode()">
                                Cancel
                            </button>
                        </div>
                        <div class="mod-reject-reasons" id="modRejectReasons">
                            <div class="mod-label">Select Rejection Reason:</div>
                            ${rejectReasonsHtml}
                            <button class="mod-secondary-btn" onclick="hideRejectReasons()" style="width: 100%; margin-top: 8px;">
                                Cancel
                            </button>
                        </div>
                        <div class="mod-secondary-actions">
                            <button class="mod-secondary-btn" onclick="skipItem()">
                                Skip for now <kbd>S</kbd>
                            </button>
                            ${modIndex > 0 ? `<button class="mod-secondary-btn" onclick="prevItem()">‚Üê Previous</button>` : ''}
                            ${modIndex < modQueue.length - 1 ? `<button class="mod-secondary-btn" onclick="nextItem()">Next ‚Üí</button>` : ''}
                        </div>
                    </div>
                </div>
            `;

            updateModProgress();
            modEditMode = false;
        }

        function toggleEditMode() {
            modEditMode = !modEditMode;
            document.getElementById('modEditSection').style.display = modEditMode ? 'block' : 'none';
            document.getElementById('modMainActions').style.display = modEditMode ? 'none' : 'flex';
            document.getElementById('modEditActions').style.display = modEditMode ? 'flex' : 'none';
            document.getElementById('modRejectReasons').classList.remove('active');

            if (modEditMode) {
                document.getElementById('modEditArea').focus();
            }
        }

        function showRejectReasons() {
            document.getElementById('modRejectReasons').classList.add('active');
        }

        function hideRejectReasons() {
            document.getElementById('modRejectReasons').classList.remove('active');
        }

        async function submitApprove() {
            await moderateCurrentItem('approve', null, null);
        }

        async function submitApproveWithEdit() {
            const editedAnswer = document.getElementById('modEditArea').value.trim();
            if (!editedAnswer) {
                alert('Please enter a corrected answer');
                return;
            }
            await moderateCurrentItem('approve', editedAnswer, 'Edited by moderator');
        }

        async function submitReject(reasonId, reasonText) {
            await moderateCurrentItem('reject', null, reasonText);
        }

        async function moderateCurrentItem(action, correctedAnswer, reason) {
            const item = modQueue[modIndex];

            try {
                const response = await fetch('/admin/moderate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: item.id,
                        action,
                        corrected_answer: correctedAnswer,
                        reason
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Update session stats
                    if (action === 'approve') {
                        modSessionStats.approved++;
                    } else {
                        modSessionStats.rejected++;
                    }

                    // Remove from queue and advance
                    modQueue.splice(modIndex, 1);
                    if (modIndex >= modQueue.length && modIndex > 0) {
                        modIndex = modQueue.length - 1;
                    }

                    loadStats();
                    renderCurrentItem();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error moderating item:', error);
                alert('Error processing action');
            }
        }

        function skipItem() {
            const item = modQueue[modIndex];
            modSkippedItems.push(item);
            modSessionStats.skipped++;
            modQueue.splice(modIndex, 1);
            if (modIndex >= modQueue.length && modIndex > 0) {
                modIndex = modQueue.length - 1;
            }
            renderCurrentItem();
        }

        function nextItem() {
            if (modIndex < modQueue.length - 1) {
                modIndex++;
                renderCurrentItem();
            }
        }

        function prevItem() {
            if (modIndex > 0) {
                modIndex--;
                renderCurrentItem();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (currentTab !== 'review') return;
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
            if (modQueue.length === 0) return;

            switch(e.key.toLowerCase()) {
                case 'a':
                    e.preventDefault();
                    if (modEditMode) {
                        submitApproveWithEdit();
                    } else {
                        submitApprove();
                    }
                    break;
                case 'r':
                    e.preventDefault();
                    if (!modEditMode) {
                        showRejectReasons();
                    }
                    break;
                case 'e':
                    e.preventDefault();
                    toggleEditMode();
                    break;
                case 's':
                    e.preventDefault();
                    skipItem();
                    break;
                case 'arrowleft':
                    e.preventDefault();
                    prevItem();
                    break;
                case 'arrowright':
                    e.preventDefault();
                    nextItem();
                    break;
                case 'escape':
                    hideRejectReasons();
                    if (modEditMode) toggleEditMode();
                    break;
                case 'b':
                    e.preventDefault();
                    toggleBulkMode();
                    break;
            }
        });

        async function loadAuditLog() {
            try {
                const response = await fetch('/admin/moderator-history');
                const history = await response.json();

                document.getElementById('auditLoading').style.display = 'none';
                const list = document.getElementById('auditList');

                if (history.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>No moderation actions yet</p></div>';
                    return;
                }

                list.innerHTML = history.map(item => {
                    const iconClass = item.action === 'approve' ? 'approve' :
                                      item.action === 'reject' ? 'reject' : 'correct';
                    const icon = item.action === 'approve' ? '‚úì' :
                                 item.action === 'reject' ? '‚úó' : '‚úé';
                    const actionText = item.action === 'approve' ? 'Approved' :
                                       item.action === 'reject' ? 'Rejected' : 'Corrected';

                    const timestamp = item.timestamp ? new Date(item.timestamp).toLocaleString() : '';

                    return `
                        <div class="audit-item">
                            <div class="audit-icon ${iconClass}">${icon}</div>
                            <div class="audit-content">
                                <div class="audit-action">${actionText}</div>
                                <div class="audit-question">${escapeHtml(item.question || 'Unknown question')}</div>
                                <div class="audit-meta">${item.moderator} ‚Ä¢ ${timestamp}</div>
                                ${item.reason ? `<div class="audit-reason">"${escapeHtml(item.reason)}"</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading audit log:', error);
                document.getElementById('auditLoading').style.display = 'none';
                document.getElementById('auditList').innerHTML = '<div class="empty-state"><p>Error loading audit log</p></div>';
            }
        }

        // Keep old function name for backwards compatibility
        async function loadReviewFeedback() {
            await loadReviewQueue();
        }

        async function loadAllFeedback() {
            try {
                const response = await fetch('/admin/feedback/all');
                const feedback = await response.json();

                document.getElementById('allLoading').style.display = 'none';
                const list = document.getElementById('allList');

                if (feedback.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>No feedback yet</p></div>';
                    return;
                }

                list.innerHTML = feedback.map(item => createFeedbackCard(item, false)).join('');
            } catch (error) {
                console.error('Error loading feedback:', error);
            }
        }

        function createFeedbackCard(item, showActions) {
            const ratingClass = item.rating === 'positive' ? 'rating-positive' : item.rating === 'negative' ? 'rating-negative' : 'rating-unrated';
            const ratingText = item.rating === 'positive' ? 'üëç Positive' : item.rating === 'negative' ? 'üëé Negative' : 'No Feedback';

            const correctionHtml = item.correction ? `
                <div class="feedback-correction">
                    <div class="correction-label">User's Correction:</div>
                    <div>${escapeHtml(item.correction)}</div>
                </div>
            ` : '';

            const actionsHtml = showActions && item.correction ? `
                <div class="feedback-actions">
                    <button class="btn btn-success" onclick="approveFeedback(${item.id})">‚úì Approve</button>
                    <button class="btn btn-danger" onclick="rejectFeedback(${item.id})">‚úó Reject</button>
                </div>
            ` : '';

            const timestamp = item.timestamp ? new Date(item.timestamp).toLocaleString() : '';

            return `
                <div class="feedback-card" id="card-${item.id}">
                    <div class="feedback-header">
                        <div class="feedback-rating ${ratingClass}">${ratingText}</div>
                        <div class="timestamp">${timestamp}</div>
                    </div>
                    <div class="feedback-question">${escapeHtml(item.question)}</div>
                    <div class="feedback-answer">${escapeHtml(item.ai_answer)}</div>
                    ${correctionHtml}
                    ${actionsHtml}
                </div>
            `;
        }

        async function approveFeedback(id) {
            try {
                const card = document.getElementById('card-' + id);
                const correction = card.querySelector('.feedback-correction div:last-child')?.textContent || '';

                await fetch('/admin/feedback/approve', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id, correction})
                });

                card.remove();
                loadStats();
            } catch (error) {
                alert('Error approving feedback');
            }
        }

        async function rejectFeedback(id) {
            try {
                await fetch('/admin/feedback/reject', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id})
                });
                document.getElementById('card-' + id).remove();
                loadStats();
            } catch (error) {
                alert('Error rejecting feedback');
            }
        }

        async function generateTrainingFile() {
            if (!confirm('Generate training file with all approved corrections?')) return;
            try {
                const response = await fetch('/admin/training/generate', {method: 'POST'});
                const data = await response.json();
                if (data.success) {
                    alert(`Training file generated!\n${data.num_examples} examples\nFile: ${data.filepath}`);
                } else {
                    alert(data.message || 'Not enough examples');
                }
            } catch (error) {
                alert('Error generating training file');
            }
        }

        function exportData() {
            alert('Export feature coming soon');
        }

        async function testAPIs() {
            await checkAPIStatus();
            alert('API status updated');
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tab === 'overview') {
                document.getElementById('overviewTab').classList.add('active');
            } else if (tab === 'review') {
                document.getElementById('reviewTab').classList.add('active');
                loadReviewQueue();
            } else if (tab === 'audit') {
                document.getElementById('auditTab').classList.add('active');
                loadAuditLog();
            } else if (tab === 'analytics') {
                document.getElementById('analyticsTab').classList.add('active');
                loadAllFeedback();
            } else if (tab === 'system') {
                document.getElementById('systemTab').classList.add('active');
                loadCacheStats();
            }
        }

        async function loadKnowledgeStatus() {
            try {
                const response = await fetch('/admin/knowledge');
                const data = await response.json();

                document.getElementById('kbIndexed').textContent = data.indexed_files || 0;
                document.getElementById('kbChunks').textContent = data.total_chunks || 0;
                document.getElementById('kbTotal').textContent = data.total_pdfs || 0;

                const unindexed = data.unindexed || 0;
                const unindexedEl = document.getElementById('kbUnindexed');
                unindexedEl.textContent = unindexed;
                unindexedEl.style.color = unindexed > 0 ? '#dc3545' : '#28a745';

                const listEl = document.getElementById('kbUnindexedList');
                if (data.unindexed_sample && data.unindexed_sample.length > 0) {
                    listEl.innerHTML = '<strong>Sample unindexed:</strong> ' +
                        data.unindexed_sample.slice(0, 5).map(f => escapeHtml(f)).join(', ') +
                        (data.unindexed > 5 ? '...' : '');
                } else {
                    listEl.innerHTML = '<span style="color: #28a745;">‚úì All PDFs indexed!</span>';
                }
            } catch (error) {
                console.error('Error loading knowledge status:', error);
            }
        }

        async function buildKnowledge(limit) {
            const statusEl = document.getElementById('kbBuildStatus');
            statusEl.innerHTML = '<span style="color: #0d6efd;">‚è≥ Building... This runs in the background. Refresh in a minute.</span>';

            try {
                const response = await fetch('/admin/knowledge/build', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({limit})
                });
                const data = await response.json();

                if (data.success) {
                    statusEl.innerHTML = '<span style="color: #28a745;">‚úì ' + escapeHtml(data.message) + '</span>';
                    // Refresh status after a delay
                    setTimeout(loadKnowledgeStatus, 3000);
                } else {
                    statusEl.innerHTML = '<span style="color: #dc3545;">‚úó Error: ' + escapeHtml(data.message || 'Unknown error') + '</span>';
                }
            } catch (error) {
                statusEl.innerHTML = '<span style="color: #dc3545;">‚úó Error starting build</span>';
            }
        }

        // =====================================================================
        // FINE-TUNING & FEEDBACK LOOP FUNCTIONS
        // =====================================================================

        async function loadFineTuningStatus() {
            try {
                const response = await fetch('/admin/fine-tuning/status');
                const data = await response.json();

                document.getElementById('ftExamples').textContent = data.training_examples_ready || 0;
                document.getElementById('ftNeeded').textContent = data.min_examples_needed || 50;
                document.getElementById('ftReady').textContent = data.ready_to_train ? '‚úì Yes' : '‚úó No';
                document.getElementById('ftReady').style.color = data.ready_to_train ? '#28a745' : '#dc3545';

                const btn = document.getElementById('startFineTuningBtn');
                btn.disabled = !data.ready_to_train;

                if (data.active_fine_tuned_model) {
                    const shortModel = data.active_fine_tuned_model.split(':').pop().substring(0, 20);
                    document.getElementById('ftModel').textContent = shortModel + '...';
                    document.getElementById('ftModel').title = data.active_fine_tuned_model;
                } else {
                    document.getElementById('ftModel').textContent = 'None';
                }

                // Show recent jobs
                if (data.recent_jobs && data.recent_jobs.length > 0) {
                    document.getElementById('ftJobs').innerHTML = `
                        <strong>Recent Jobs:</strong>
                        <div style="margin-top: 8px;">
                            ${data.recent_jobs.slice(0, 3).map(job => `
                                <div style="padding: 6px 0; border-bottom: 1px solid #eee;">
                                    <span class="bulk-item-badge ${job.status === 'succeeded' ? 'conf-high' : job.status === 'failed' ? 'conf-low' : ''}">${job.status}</span>
                                    ${job.created_at ? new Date(job.created_at).toLocaleDateString() : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error loading fine-tuning status:', error);
            }
        }

        async function startFineTuning() {
            if (!confirm('Start fine-tuning pipeline? This will upload training data and begin model training.')) {
                return;
            }

            const statusEl = document.getElementById('ftStatus');
            statusEl.innerHTML = '<span style="color: #007bff;">‚è≥ Starting fine-tuning pipeline...</span>';

            try {
                const response = await fetch('/admin/fine-tuning/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    statusEl.innerHTML = `
                        <span style="color: #28a745;">‚úì Fine-tuning started!</span><br>
                        <span style="font-size: 12px;">Job ID: ${result.job_id}</span>
                    `;
                } else {
                    statusEl.innerHTML = `<span style="color: #dc3545;">‚úó ${result.error || 'Failed to start'}</span>`;
                }

                loadFineTuningStatus();

            } catch (error) {
                statusEl.innerHTML = '<span style="color: #dc3545;">‚úó Error starting fine-tuning</span>';
                console.error('Fine-tuning error:', error);
            }
        }

        async function loadSourceQuality() {
            try {
                const response = await fetch('/admin/source-quality');
                const data = await response.json();

                const lowQuality = data.low_quality || [];

                if (lowQuality.length > 0) {
                    document.getElementById('lowQualitySources').innerHTML = `
                        <strong style="color: #dc3545;">‚ö†Ô∏è Low Quality Sources (${lowQuality.length})</strong>
                        <div style="margin-top: 8px; font-size: 13px;">
                            ${lowQuality.slice(0, 5).map(s => `
                                <div style="padding: 8px; background: #fff3cd; border-radius: 4px; margin-bottom: 6px;">
                                    <strong>${escapeHtml(s.name)}</strong><br>
                                    <span style="color: #6c757d;">Score: ${(s.score * 100).toFixed(0)}% | üëç ${s.positive} | üëé ${s.negative}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    document.getElementById('lowQualitySources').innerHTML = `
                        <span style="color: #28a745;">‚úì No low-quality sources detected</span>
                    `;
                }

            } catch (error) {
                console.error('Error loading source quality:', error);
            }
        }

        async function runEvaluation() {
            if (!confirm('Run evaluation against test questions? This may take a minute.')) {
                return;
            }

            const statusEl = document.getElementById('ftStatus');
            statusEl.innerHTML = '<span style="color: #007bff;">‚è≥ Running evaluation...</span>';

            try {
                const response = await fetch('/admin/eval/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (result.error) {
                    statusEl.innerHTML = `<span style="color: #dc3545;">‚úó ${result.error}</span>`;
                    return;
                }

                const summary = result.summary || {};
                statusEl.innerHTML = `
                    <div style="background: #e8f5e9; padding: 12px; border-radius: 6px;">
                        <strong>‚úì Evaluation Complete</strong><br>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px; font-size: 13px;">
                            <div>Questions: ${summary.total_questions || 0}</div>
                            <div>Avg Score: ${summary.avg_overall_score || 0}%</div>
                            <div>Avg Confidence: ${summary.avg_confidence || 0}%</div>
                            <div>Keyword Match: ${summary.avg_keyword_score || 0}%</div>
                        </div>
                    </div>
                `;

                loadEvalHistory();

            } catch (error) {
                statusEl.innerHTML = '<span style="color: #dc3545;">‚úó Evaluation failed</span>';
                console.error('Evaluation error:', error);
            }
        }

        async function loadEvalHistory() {
            try {
                const response = await fetch('/admin/eval/history?limit=5');
                const history = await response.json();

                if (history.length === 0) {
                    document.getElementById('evalHistory').innerHTML = `
                        <p style="color: #6c757d; font-size: 13px;">No evaluations run yet.</p>
                    `;
                    return;
                }

                document.getElementById('evalHistory').innerHTML = `
                    <table style="width: 100%; font-size: 13px;">
                        <tr style="text-align: left; color: #6c757d;">
                            <th>Date</th>
                            <th>Questions</th>
                            <th>Score</th>
                            <th>Confidence</th>
                        </tr>
                        ${history.map(h => `
                            <tr>
                                <td>${new Date(h.run_date).toLocaleDateString()}</td>
                                <td>${h.total_questions}</td>
                                <td>${h.avg_overall_score}%</td>
                                <td>${h.avg_confidence}%</td>
                            </tr>
                        `).join('')}
                    </table>
                `;

            } catch (error) {
                console.error('Error loading eval history:', error);
            }
        }

        // Initial load
        loadAllData();
        loadFineTuningStatus();
        loadSourceQuality();
        loadEvalHistory();
        loadKnowledgeStatus();
    </script>
</body>
</html>
