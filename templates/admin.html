<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a4d2e">
    <title>Admin Dashboard - Greenside AI</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='8' fill='%231a4d2e'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-family='system-ui' font-size='18' font-weight='700' fill='white'%3EG%3C/text%3E%3C/svg%3E">
    <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body>
    <header>
        <div class="header-left">
            <a href="/" class="back-link">‚Üê Back</a>
            <div class="logo">Greenside AI</div>
            <div class="admin-badge">Admin</div>
        </div>
        <div class="header-right">
            <button class="header-btn" onclick="loadAllData()">‚Üª Refresh</button>
        </div>
    </header>

    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="stat-number" id="statQueries">-</div>
            <div class="stat-label">Total Queries</div>
        </div>
        <div class="stat-card">
            <div class="stat-number info" id="statToday">-</div>
            <div class="stat-label">Today</div>
        </div>
        <div class="stat-card">
            <div class="stat-number success" id="statPositive">-</div>
            <div class="stat-label">üëç Positive</div>
        </div>
        <div class="stat-card">
            <div class="stat-number warning" id="statNegative">-</div>
            <div class="stat-label">üëé Negative</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="statPending">-</div>
            <div class="stat-label">Needs Review</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="statAvgConf">-</div>
            <div class="stat-label">Avg Confidence</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="statCacheRate">-</div>
            <div class="stat-label">Cache Hit Rate</div>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
            <button class="tab-btn" onclick="switchTab('review')">Moderation Queue</button>
            <button class="tab-btn" onclick="switchTab('audit')">Audit Log</button>
            <button class="tab-btn" onclick="switchTab('analytics')">Analytics</button>
            <button class="tab-btn" onclick="switchTab('system')">System</button>
            <button class="tab-btn" onclick="switchTab('intelligence')" style="background: linear-gradient(135deg, #1a4d2e, #2d7a4a); color: white; border-color: #1a4d2e;">Intelligence</button>
        </div>

        <!-- Overview Tab -->
        <div class="tab-content active" id="overviewTab">
            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Recent Questions</div>
                    </div>
                    <div class="question-list" id="recentQuestions">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">System Status</div>
                    </div>
                    <div class="status-grid" id="systemStatus">
                        <div class="status-item">
                            <div class="status-indicator status-online"></div>
                            <div class="status-label">OpenAI API</div>
                            <div class="status-value">Connected</div>
                        </div>
                        <div class="status-item">
                            <div class="status-indicator status-online"></div>
                            <div class="status-label">Pinecone</div>
                            <div class="status-value">Connected</div>
                        </div>
                        <div class="status-item">
                            <div class="status-indicator" id="weatherStatus"></div>
                            <div class="status-label">Weather API</div>
                            <div class="status-value" id="weatherStatusText">-</div>
                        </div>
                        <div class="status-item">
                            <div class="status-indicator" id="tavilyStatus"></div>
                            <div class="status-label">Web Search</div>
                            <div class="status-value" id="tavilyStatusText">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Top Topics</div>
                    </div>
                    <div class="topic-list" id="topTopics">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Quick Actions</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn btn-primary" onclick="switchTab('review')">
                            Review Pending Feedback
                        </button>
                        <button class="btn btn-secondary" onclick="testAPIs()">
                            Test API Connections
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Export Data</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <a href="/admin/export/feedback" class="btn btn-secondary" download>
                            üì• Export All Feedback (CSV)
                        </a>
                        <a href="/admin/export/training" class="btn btn-secondary" download>
                            üì• Export Training Data (CSV)
                        </a>
                        <a href="/admin/export/moderation" class="btn btn-secondary" download>
                            üì• Export Moderation Log (CSV)
                        </a>
                        <button class="btn btn-secondary" onclick="exportAnalyticsJson()">
                            üìä Export Analytics (JSON)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review/Moderation Tab -->
        <div class="tab-content" id="reviewTab">
            <div class="mod-container">
                <!-- Trending Issues Alert -->
                <div id="trendingAlert" class="trending-alert" style="display: none;">
                    <div class="trending-header">
                        <span class="trending-icon">üî•</span>
                        <strong>Trending Issues</strong>
                        <button class="trending-close" onclick="hideTrendingAlert()">√ó</button>
                    </div>
                    <div id="trendingList" class="trending-list"></div>
                </div>

                <!-- Filter Bar with Mode Toggle -->
                <div class="mod-filter-bar">
                    <button class="mod-filter-btn active" data-filter="all" onclick="setModFilter('all')">All</button>
                    <button class="mod-filter-btn" data-filter="negative" onclick="setModFilter('negative')">User Flagged</button>
                    <button class="mod-filter-btn" data-filter="low_confidence" onclick="setModFilter('low_confidence')">Low Confidence</button>
                    <button class="mod-filter-btn" data-filter="priority" onclick="setModFilter('priority')">üî• Priority</button>
                    <div style="flex: 1;"></div>
                    <button class="mod-filter-btn" id="bulkModeBtn" onclick="toggleBulkMode()">‚òê Bulk Mode</button>
                </div>

                <!-- Bulk Actions Bar (hidden by default) -->
                <div id="bulkActionsBar" class="bulk-actions-bar" style="display: none;">
                    <div class="bulk-select-info">
                        <span id="bulkSelectedCount">0</span> selected
                        <button class="bulk-select-btn" onclick="selectAllVisible()">Select All</button>
                        <button class="bulk-select-btn" onclick="clearSelection()">Clear</button>
                    </div>
                    <div class="bulk-actions">
                        <button class="btn btn-success" onclick="bulkApprove()">‚úì Approve Selected</button>
                        <button class="btn btn-danger" onclick="bulkReject()">‚úó Reject Selected</button>
                        <button class="btn btn-primary" onclick="bulkApproveHighConfidence()">‚ö° Auto-Approve High Confidence</button>
                    </div>
                </div>

                <!-- Progress Header -->
                <div class="mod-header">
                    <div class="mod-progress">
                        <div class="mod-progress-text" id="modProgressText">Loading...</div>
                        <div class="mod-progress-bar">
                            <div class="mod-progress-fill" id="modProgressFill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="mod-stats">
                        <div class="mod-stat">
                            <span class="mod-stat-num" id="modApproved">0</span> approved
                        </div>
                        <div class="mod-stat">
                            <span class="mod-stat-num" id="modRejected">0</span> rejected
                        </div>
                        <div class="mod-stat">
                            <span class="mod-stat-num" id="modSkipped">0</span> skipped
                        </div>
                    </div>
                </div>

                <!-- Keyboard Shortcuts Hint -->
                <div class="mod-shortcuts" style="text-align: center; margin-bottom: 16px;">
                    <kbd>A</kbd> Approve &nbsp; <kbd>R</kbd> Reject &nbsp; <kbd>E</kbd> Edit Mode &nbsp; <kbd>S</kbd> Skip &nbsp; <kbd>‚Üê</kbd><kbd>‚Üí</kbd> Navigate &nbsp; <kbd>B</kbd> Bulk Mode
                </div>

                <!-- Loading State -->
                <div class="loading" id="modLoading">
                    <div class="spinner"></div>
                    <p>Loading queue...</p>
                </div>

                <!-- Main Moderation Card (single item mode) -->
                <div id="modCardContainer" style="display: none;"></div>

                <!-- Bulk Mode List -->
                <div id="bulkListContainer" class="bulk-list-container" style="display: none;"></div>

                <!-- Empty State -->
                <div class="mod-empty" id="modEmpty" style="display: none;">
                    <div class="mod-empty-icon">‚úì</div>
                    <div class="mod-empty-title">Queue Clear!</div>
                    <div class="mod-empty-text">No items need review. Great work!</div>
                </div>
            </div>
        </div>

        <!-- Audit Log Tab -->
        <div class="tab-content" id="auditTab">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Moderator Activity Log</div>
                    <button class="btn btn-secondary" onclick="loadAuditLog()">Refresh</button>
                </div>
                <div class="loading" id="auditLoading">
                    <div class="spinner"></div>
                </div>
                <div id="auditList"></div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-content" id="analyticsTab">
            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Daily Query Volume (14 days)</div>
                    </div>
                    <canvas id="volumeChart" height="180" style="width: 100%;"></canvas>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Confidence Trend</div>
                    </div>
                    <canvas id="confidenceChart" height="180" style="width: 100%;"></canvas>
                </div>
            </div>

            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Rating Breakdown</div>
                    </div>
                    <canvas id="ratingsChart" height="180" style="width: 100%;"></canvas>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Confidence Distribution</div>
                    </div>
                    <div class="topic-list" id="confidenceDistribution">
                        <div class="topic-item">
                            <div class="topic-name">High (80%+)</div>
                            <div class="topic-bar-container">
                                <div class="topic-bar" id="confHigh" style="width: 0%">0%</div>
                            </div>
                        </div>
                        <div class="topic-item">
                            <div class="topic-name">Medium</div>
                            <div class="topic-bar-container">
                                <div class="topic-bar" id="confMed" style="width: 0%; background: linear-gradient(90deg, #ffc107, #ffca2c);">0%</div>
                            </div>
                        </div>
                        <div class="topic-item">
                            <div class="topic-name">Low (<60%)</div>
                            <div class="topic-bar-container">
                                <div class="topic-bar" id="confLow" style="width: 0%; background: linear-gradient(90deg, #dc3545, #e4606d);">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">All Feedback History</div>
                    <button class="btn btn-secondary" onclick="loadAllFeedback()">Refresh</button>
                </div>
                <div class="loading" id="allLoading">
                    <div class="spinner"></div>
                </div>
                <div class="feedback-list" id="allList"></div>
            </div>
        </div>

        <!-- System Tab -->
        <div class="tab-content" id="systemTab">
            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Embedding Cache</div>
                        <button class="btn btn-secondary" onclick="loadCacheStats()">Refresh</button>
                    </div>
                    <div class="cache-grid">
                        <div class="cache-stat">
                            <div class="cache-stat-label">Size</div>
                            <div class="cache-stat-value" id="embCacheSize">-</div>
                        </div>
                        <div class="cache-stat">
                            <div class="cache-stat-label">Hits</div>
                            <div class="cache-stat-value" id="embCacheHits">-</div>
                        </div>
                        <div class="cache-stat">
                            <div class="cache-stat-label">Misses</div>
                            <div class="cache-stat-value" id="embCacheMisses">-</div>
                        </div>
                        <div class="cache-stat">
                            <div class="cache-stat-label">Hit Rate</div>
                            <div class="cache-stat-value" id="embCacheRate">-</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Source URL Cache</div>
                    </div>
                    <div class="cache-grid">
                        <div class="cache-stat">
                            <div class="cache-stat-label">Size</div>
                            <div class="cache-stat-value" id="urlCacheSize">-</div>
                        </div>
                        <div class="cache-stat">
                            <div class="cache-stat-label">Hits</div>
                            <div class="cache-stat-value" id="urlCacheHits">-</div>
                        </div>
                        <div class="cache-stat">
                            <div class="cache-stat-label">Misses</div>
                            <div class="cache-stat-value" id="urlCacheMisses">-</div>
                        </div>
                        <div class="cache-stat">
                            <div class="cache-stat-label">Hit Rate</div>
                            <div class="cache-stat-value" id="urlCacheRate">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Training Data</div>
                </div>
                <p style="color: #6c757d; margin-bottom: 12px; font-size: 14px;">
                    Approve corrections in the Review tab to build training data. 50 examples needed for fine-tuning.
                </p>
                <div style="margin-bottom: 16px;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="trainingProgress" style="width: 0%">0%</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 13px; color: #6c757d;" id="trainingText"></div>
                </div>
                <button class="btn btn-primary" id="generateTrainingBtn" onclick="generateTrainingFile()">
                    Generate Training File (JSONL)
                </button>
                <div style="margin-top: 8px; font-size: 12px; color: #6c757d;">
                    Generates data/training_data.jsonl with the Greenside AI system prompt
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Knowledge Base</div>
                    <button class="btn btn-secondary" onclick="loadKnowledgeStatus()">Refresh</button>
                </div>

                <!-- Pinecone totals -->
                <div style="margin-bottom: 16px; padding: 12px; background: #f0f7ff; border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">Pinecone Vector Store</div>
                    <div style="font-size: 24px; font-weight: 700; color: #0d6efd;" id="kbPineconeTotal">-</div>
                    <div style="font-size: 12px; color: #6c757d;">total vectors</div>
                </div>

                <div id="kbScrapedSources" style="margin-bottom: 16px; font-size: 13px;"></div>

                <!-- PDF indexing -->
                <div style="font-weight: 600; margin-bottom: 8px;">PDF Documents</div>
                <div class="cache-grid" style="margin-bottom: 16px;">
                    <div class="cache-stat">
                        <div class="cache-stat-label">Indexed PDFs</div>
                        <div class="cache-stat-value" id="kbIndexed">-</div>
                    </div>
                    <div class="cache-stat">
                        <div class="cache-stat-label">PDF Chunks</div>
                        <div class="cache-stat-value" id="kbChunks">-</div>
                    </div>
                    <div class="cache-stat">
                        <div class="cache-stat-label">Total PDFs</div>
                        <div class="cache-stat-value" id="kbTotal">-</div>
                    </div>
                    <div class="cache-stat">
                        <div class="cache-stat-label">Unindexed</div>
                        <div class="cache-stat-value" id="kbUnindexed" style="color: #dc3545;">-</div>
                    </div>
                </div>
                <div id="kbUnindexedList" style="margin-bottom: 16px; font-size: 13px; color: #6c757d;"></div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="buildKnowledge(10)">
                        Index 10 Files
                    </button>
                    <button class="btn btn-secondary" onclick="buildKnowledge(50)">
                        Index 50 Files
                    </button>
                </div>
                <div id="kbBuildStatus" style="margin-top: 12px; font-size: 13px;"></div>
            </div>

            <!-- Fine-tuning Section -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üîÑ Feedback Loop</div>
                    <button class="btn btn-secondary" onclick="loadFineTuningStatus()">Refresh</button>
                </div>

                <!-- Training Data Status -->
                <div class="cache-grid" style="margin-bottom: 16px;">
                    <div class="cache-stat">
                        <div class="cache-stat-label">Training Examples</div>
                        <div class="cache-stat-value" id="ftExamples">-</div>
                    </div>
                    <div class="cache-stat">
                        <div class="cache-stat-label">Needed</div>
                        <div class="cache-stat-value" id="ftNeeded">50</div>
                    </div>
                    <div class="cache-stat">
                        <div class="cache-stat-label">Ready to Train</div>
                        <div class="cache-stat-value" id="ftReady">-</div>
                    </div>
                    <div class="cache-stat">
                        <div class="cache-stat-label">Active Model</div>
                        <div class="cache-stat-value" id="ftModel" style="font-size: 11px;">-</div>
                    </div>
                </div>

                <!-- Fine-tuning Actions -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px;">
                    <button class="btn btn-primary" id="startFineTuningBtn" onclick="startFineTuning()" disabled>
                        üöÄ Start Fine-tuning
                    </button>
                    <button class="btn btn-secondary" onclick="runEvaluation()">
                        üìä Run Evaluation
                    </button>
                </div>

                <div id="ftStatus" style="font-size: 13px; margin-bottom: 12px;"></div>

                <!-- Recent Jobs -->
                <div id="ftJobs" style="font-size: 13px;"></div>
            </div>

            <!-- Source Quality Section -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìà Source Quality</div>
                    <button class="btn btn-secondary" onclick="loadSourceQuality()">Refresh</button>
                </div>
                <div id="sourceQualityContent">
                    <p style="color: #6c757d; font-size: 13px;">Source quality is tracked based on user feedback. Sources that consistently lead to good answers get boosted in search results.</p>
                </div>
                <div id="lowQualitySources" style="margin-top: 12px;"></div>
            </div>

            <!-- Evaluation History -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìä Evaluation History</div>
                </div>
                <div id="evalHistory">
                    <p style="color: #6c757d; font-size: 13px;">Run evaluations to track model quality over time.</p>
                </div>
            </div>
        </div>

        <!-- Intelligence Tab -->
        <div class="tab-content" id="intelligenceTab">
            <!-- Intelligence Overview Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px;">
                <div class="card" style="padding: 16px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: #1a4d2e;" id="intelGoldenCount">-</div>
                    <div style="font-size: 12px; color: #6b7280;">Golden Answers</div>
                </div>
                <div class="card" style="padding: 16px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: #2563eb;" id="intelABTests">-</div>
                    <div style="font-size: 12px; color: #6b7280;">Active A/B Tests</div>
                </div>
                <div class="card" style="padding: 16px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: #7c3aed;" id="intelSources">-</div>
                    <div style="font-size: 12px; color: #6b7280;">Tracked Sources</div>
                </div>
                <div class="card" style="padding: 16px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: #059669;" id="intelCalibPoints">-</div>
                    <div style="font-size: 12px; color: #6b7280;">Calibration Points</div>
                </div>
                <div class="card" style="padding: 16px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: #d97706;" id="intelTopics">-</div>
                    <div style="font-size: 12px; color: #6b7280;">Topic Clusters</div>
                </div>
                <div class="card" style="padding: 16px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: #dc2626;" id="intelEscalations">-</div>
                    <div style="font-size: 12px; color: #6b7280;">Open Escalations</div>
                </div>
                <div class="card" style="padding: 16px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: #0891b2;" id="intelPredAccuracy">-</div>
                    <div style="font-size: 12px; color: #6b7280;">Prediction Accuracy</div>
                </div>
                <div class="card" style="padding: 16px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: #4f46e5;" id="intelRegTests">-</div>
                    <div style="font-size: 12px; color: #6b7280;">Regression Tests</div>
                </div>
            </div>

            <!-- Subsystem Panels -->
            <div class="two-col">
                <!-- Self-Healing Knowledge Loop -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Self-Healing Knowledge Loop</div>
                        <button class="btn btn-secondary" onclick="loadWeakPatterns()" style="font-size: 12px; padding: 4px 10px;">Detect Weak Patterns</button>
                    </div>
                    <div id="weakPatterns" style="margin-bottom: 12px;">
                        <p style="color: #6b7280; font-size: 13px;">Click "Detect Weak Patterns" to find recurring low-quality answers.</p>
                    </div>
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 12px;">
                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px;">Golden Answers</div>
                        <div id="goldenAnswersList">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 12px; margin-top: 12px;">
                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px;">Create Golden Answer</div>
                        <input type="text" id="goldenQuestion" placeholder="Question pattern" style="width: 100%; padding: 6px 10px; margin-bottom: 6px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                        <textarea id="goldenAnswer" placeholder="Ideal answer" rows="3" style="width: 100%; padding: 6px 10px; margin-bottom: 6px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; resize: vertical;"></textarea>
                        <input type="text" id="goldenCategory" placeholder="Category (optional)" style="width: 100%; padding: 6px 10px; margin-bottom: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                        <button class="btn btn-primary" onclick="createGoldenAnswer()" style="font-size: 12px; padding: 6px 14px;">Create Golden Answer</button>
                    </div>
                </div>

                <!-- Smart Escalation Queue -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Smart Escalation Queue</div>
                        <button class="btn btn-secondary" onclick="loadEscalations()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                    </div>
                    <div id="escalationStats" style="display: flex; gap: 12px; margin-bottom: 12px;"></div>
                    <div id="escalationQueue">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <!-- Source Quality Intelligence -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Source Reliability Leaderboard</div>
                        <button class="btn btn-secondary" onclick="loadSourceLeaderboard()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                    </div>
                    <div id="sourceLeaderboard">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Confidence Calibration -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Confidence Calibration</div>
                        <button class="btn btn-secondary" onclick="loadCalibration()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                    </div>
                    <div id="calibrationReport">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <!-- Topic Intelligence -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Topic Intelligence</div>
                        <div style="display: flex; gap: 6px;">
                            <button class="btn btn-secondary" onclick="loadTopics()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                            <button class="btn btn-primary" onclick="runClustering()" style="font-size: 12px; padding: 4px 10px;">Run Clustering</button>
                        </div>
                    </div>
                    <div id="topicDashboard">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Regression Detection -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Regression Detection</div>
                        <div style="display: flex; gap: 6px;">
                            <button class="btn btn-secondary" onclick="loadRegressionDashboard()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                            <button class="btn btn-primary" onclick="runRegressionSuite()" style="font-size: 12px; padding: 4px 10px;">Run Suite</button>
                        </div>
                    </div>
                    <div id="regressionDashboard">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 12px; margin-top: 12px;">
                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px;">Add Regression Test</div>
                        <input type="text" id="regTestQuestion" placeholder="Test question" style="width: 100%; padding: 6px 10px; margin-bottom: 6px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                        <textarea id="regTestExpected" placeholder="Expected answer (or key phrases)" rows="2" style="width: 100%; padding: 6px 10px; margin-bottom: 6px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; resize: vertical;"></textarea>
                        <input type="text" id="regTestCriteria" placeholder="Criteria keywords (comma-separated)" style="width: 100%; padding: 6px 10px; margin-bottom: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                        <button class="btn btn-primary" onclick="addRegressionTest()" style="font-size: 12px; padding: 6px 14px;">Add Test</button>
                    </div>
                </div>
            </div>

            <!-- A/B Testing & Satisfaction Prediction -->
            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">A/B Testing</div>
                        <button class="btn btn-secondary" onclick="loadABTests()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                    </div>
                    <div id="abTestsList">
                        <p style="color: #6b7280; font-size: 13px;">No active A/B tests. Create answer versions and tests via the API.</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Satisfaction Prediction</div>
                        <button class="btn btn-primary" onclick="trainSatisfactionModel()" style="font-size: 12px; padding: 4px 10px;">Train Model</button>
                    </div>
                    <div id="satisfactionStats">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <!-- ============== ENTERPRISE INTELLIGENCE ============== -->
            <div style="margin-top: 24px; border-top: 2px solid #1a4d2e; padding-top: 16px;">
                <h3 style="color: #1a4d2e; font-size: 16px; font-weight: 700; margin-bottom: 12px;">Enterprise Intelligence</h3>
                <!-- Enterprise Overview Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <div class="card" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: #1a4d2e;" id="intelHealthScore">-</div>
                        <div style="font-size: 12px; color: #6b7280;">System Health</div>
                    </div>
                    <div class="card" style="padding: 16px; text-align: center;">
                        <div style="font-size: 22px; font-weight: 700; color: #059669;" id="intelTotalCost">-</div>
                        <div style="font-size: 12px; color: #6b7280;">Total Cost (USD)</div>
                    </div>
                    <div class="card" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: #d97706;" id="intelAnomalies">-</div>
                        <div style="font-size: 12px; color: #6b7280;">Active Anomalies</div>
                    </div>
                    <div class="card" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: #dc2626;" id="intelAlerts">-</div>
                        <div style="font-size: 12px; color: #6b7280;">Active Alerts</div>
                    </div>
                    <div class="card" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: #7c3aed;" id="intelBreakers">-</div>
                        <div style="font-size: 12px; color: #6b7280;">Open Breakers</div>
                    </div>
                    <div class="card" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: #2563eb;" id="intelPromptVersions">-</div>
                        <div style="font-size: 12px; color: #6b7280;">Prompt Versions</div>
                    </div>
                    <div class="card" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: #e11d48;" id="intelGaps">-</div>
                        <div style="font-size: 12px; color: #6b7280;">Knowledge Gaps</div>
                    </div>
                    <div class="card" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: #4f46e5;" id="intelPipelineCount">-</div>
                        <div style="font-size: 12px; color: #6b7280;">Requests Tracked</div>
                    </div>
                    <div class="card" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: #059669;" id="intelFlagsEnabled">-</div>
                        <div style="font-size: 12px; color: #6b7280;">Flags Enabled</div>
                    </div>
                    <div class="card" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: #dc2626;" id="intelRateBlocked">-</div>
                        <div style="font-size: 12px; color: #6b7280;">Rate Blocked</div>
                    </div>
                    <div class="card" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: #7c3aed;" id="intelBudgetDailyPct">-</div>
                        <div style="font-size: 12px; color: #6b7280;">Daily Budget %</div>
                    </div>
                    <div class="card" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700;" id="intelTrainingReady">-</div>
                        <div style="font-size: 12px; color: #6b7280;">Training Ready</div>
                    </div>
                </div>
            </div>

            <!-- Enterprise Subsystem Panels -->
            <div class="two-col">
                <!-- Pipeline Analytics -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Pipeline Analytics</div>
                        <button class="btn btn-secondary" onclick="loadPipelineMetrics()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                    </div>
                    <div id="pipelineMetrics">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Executive Health -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Executive Health Score</div>
                        <button class="btn btn-secondary" onclick="loadExecutiveHealth()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                    </div>
                    <div id="executiveHealth">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Anomaly Detection -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Anomaly Detection</div>
                        <div>
                            <button class="btn btn-primary" onclick="runAnomalyCheck()" style="font-size: 12px; padding: 4px 10px;">Run Check</button>
                            <button class="btn btn-secondary" onclick="loadAnomalies()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                        </div>
                    </div>
                    <div id="anomalyList">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Alert System -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Alert System</div>
                        <button class="btn btn-secondary" onclick="loadAlerts()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                    </div>
                    <div id="alertRulesList" style="margin-bottom: 12px;"></div>
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 8px;">
                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 6px;">Recent Alerts</div>
                        <div id="alertHistory" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Circuit Breakers -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Circuit Breakers</div>
                        <button class="btn btn-secondary" onclick="loadCircuitBreakers()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                    </div>
                    <div id="circuitBreakerList">
                        <p style="color: #6b7280; font-size: 13px;">Circuit breakers auto-disable failing sources after repeated failures.</p>
                    </div>
                </div>

                <!-- Prompt Versioning -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Prompt Versioning</div>
                        <button class="btn btn-secondary" onclick="loadPromptVersions()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                    </div>
                    <div id="promptVersionList">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Knowledge Gaps -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Knowledge Gaps</div>
                        <div>
                            <button class="btn btn-primary" onclick="detectKnowledgeGaps()" style="font-size: 12px; padding: 4px 10px;">Detect Gaps</button>
                            <button class="btn btn-secondary" onclick="loadKnowledgeGaps()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                        </div>
                    </div>
                    <div id="knowledgeGapList">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Conversation Intelligence -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Conversation Intelligence</div>
                        <div>
                            <button class="btn btn-primary" onclick="analyzeConversations()" style="font-size: 12px; padding: 4px 10px;">Analyze</button>
                            <button class="btn btn-secondary" onclick="loadConversationMetrics()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                        </div>
                    </div>
                    <div id="conversationMetrics">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <!-- Gradient Boosted Model -->
            <div class="card" style="margin-top: 12px;">
                <div class="card-header">
                    <div class="card-title">Gradient Boosted Predictor</div>
                    <div>
                        <button class="btn btn-primary" onclick="trainGradientBoosted()" style="font-size: 12px; padding: 4px 10px;">Train Model</button>
                        <button class="btn btn-secondary" onclick="loadFeatureImportance()" style="font-size: 12px; padding: 4px 10px;">Feature Importance</button>
                    </div>
                </div>
                <div id="gradientBoostedPanel">
                    <p style="color: #6b7280; font-size: 13px;">Pure-Python gradient boosted decision trees with 20+ features. Train the model to improve satisfaction prediction.</p>
                </div>
            </div>

            <!-- ROI Metrics -->
            <div class="card" style="margin-top: 12px;">
                <div class="card-header">
                    <div class="card-title">ROI Metrics</div>
                    <button class="btn btn-secondary" onclick="loadROI()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                </div>
                <div id="roiPanel">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Anthropic-Grade: Feature Flags -->
            <div class="card" style="margin-top: 12px;">
                <div class="card-header">
                    <div class="card-title">Feature Flags</div>
                    <button class="btn btn-secondary" onclick="loadFeatureFlags()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                </div>
                <div id="featureFlagsPanel">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Anthropic-Grade: Cost Budget -->
            <div class="card" style="margin-top: 12px;">
                <div class="card-header">
                    <div class="card-title">Cost Budget</div>
                    <button class="btn btn-secondary" onclick="loadCostBudget()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                </div>
                <div id="costBudgetPanel">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            </div><!-- close first column -->
            <div><!-- second column for new panels -->

            <!-- Anthropic-Grade: Data Retention -->
            <div class="card" style="margin-top: 12px;">
                <div class="card-header">
                    <div class="card-title">Data Retention</div>
                    <div>
                        <button class="btn btn-secondary" onclick="loadDataRetention()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                        <button class="btn btn-primary" onclick="runDataRetention()" style="font-size: 12px; padding: 4px 10px;">Run Cleanup</button>
                    </div>
                </div>
                <div id="dataRetentionPanel">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Anthropic-Grade: Training Readiness -->
            <div class="card" style="margin-top: 12px;">
                <div class="card-header">
                    <div class="card-title">Training Readiness</div>
                    <button class="btn btn-secondary" onclick="loadTrainingStatus()" style="font-size: 12px; padding: 4px 10px;">Check</button>
                </div>
                <div id="trainingStatusPanel">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Intelligence Event Log -->
            <div class="card" style="margin-top: 12px;">
                <div class="card-header">
                    <div class="card-title">Intelligence Event Log</div>
                    <button class="btn btn-secondary" onclick="loadIntelEvents()" style="font-size: 12px; padding: 4px 10px;">Refresh</button>
                </div>
                <div id="intelEventLog" style="max-height: 300px; overflow-y: auto;">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/admin.js"></script>
</body>
</html>
